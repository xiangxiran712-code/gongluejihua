<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>攻略计划</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        :root {
            --bg-color: #1a202c;
            --text-color: #ffffff;
            --glass-container-bg: rgba(255, 255, 255, 0.15);
            --user-bubble-bg: rgba(60, 179, 113, 0.7);
            --user-bubble-text: #ffffff;
            --ai-bubble-bg: rgba(255, 255, 255, 0.8);
            --ai-bubble-text: #000000;
            --main-btn-bg: #4c51bf;
            --main-btn-hover: #434190;
            --custom-font: 'Inter', sans-serif;
        }

        html { height: 100%; }
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #2d3748;
            padding: 20px;
            box-sizing: border-box;
            font-family: var(--custom-font);
            color: var(--text-color); /* 全局文字颜色 */
            transition: padding 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .phone-wrapper {
            width: 95vw;
            max-width: 420px;
            aspect-ratio: 390 / 844;
            margin: auto;
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #phone-frame {
            position: relative;
            width: 100%;
            height: 100%;
            background: #111;
            border-radius: 40px;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5); /* 内部阴影已移除 */
            padding: 10px;
            box-sizing: border-box;
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #phone-screen {
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            border-radius: 30px;
            overflow: hidden;
            position: relative;
            transition: background-image 0.5s ease-in-out, background-color 0.5s ease-in-out, border-radius 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            /* Prevents browser-level pull-to-refresh/navigation gestures */
            touch-action: none;
        }
        /* --- Fullscreen Mode --- */
        body.fullscreen-mode {
            padding: 0;
        }
        body.fullscreen-mode .phone-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-width: none;
            aspect-ratio: auto;
            z-index: 10000;
        }
        body.fullscreen-mode #phone-frame {
            border-radius: 0;
            box-shadow: none;
            padding: 0;
        }
        body.fullscreen-mode #phone-screen {
            border-radius: 0;
        }
        
        /* --- Fullscreen Home Page Layout Adjustments --- */
        body.fullscreen-mode #home-content-wrapper {
            /* This makes the wrapper disappear, promoting its children to be positioned relative to #home-page */
            display: contents;
        }
        body.fullscreen-mode #home-avatar-section,
        body.fullscreen-mode #home-buttons-section {
            position: absolute;
            width: auto;
            padding: 0;
        }
        body.fullscreen-mode #home-avatar-section {
            top: 50%; /* <<<<< MODIFIED: Moved down to be vertically centered on the left side */
            left: 25%;
            transform: translate(-50%, -50%);
            align-items: center;
        }
        body.fullscreen-mode #home-buttons-section {
            top: 50%;
            right: 25%;
            transform: translate(50%, -50%);
        }
        body.fullscreen-mode .mini-player-container {
            top: 80%;
            left: 50%;
            bottom: auto;
            transform: translate(-50%, -50%);
        }
        
        #app.container {
            height: 100%;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* This class allows elements to be scrolled normally */
        .scrollable-content {
            touch-action: pan-y; /* Allow vertical scrolling */
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
        }
        .glass-container {
            background: var(--glass-container-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .menu-btn {
            padding: 0.6rem 1.5rem;
            font-weight: bold;
            font-size: 1rem;
            width: 140px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background: var(--glass-container-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 9999px;
            color: var(--text-color);
        }
        .menu-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .message-bubble {
            display: inline-block;
            font-size: 0.9rem;
            padding: 0.6rem 0.9rem;
            max-width: 75%;
            word-wrap: break-word;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
        }
        .message-bubble.user {
            background-color: var(--user-bubble-bg);
            align-self: flex-end;
            border-radius: 12px 12px 0 12px;
            color: var(--user-bubble-text); /* 独立颜色 */
        }
        .message-bubble.ai {
            background-color: var(--ai-bubble-bg);
            align-self: flex-start;
            border-radius: 12px 12px 12px 0;
            color: var(--ai-bubble-text); /* 独立颜色 */
        }
        .chat-header, .chat-footer, .batch-actions-footer {
            position: sticky;
            width: 100%;
            z-index: 10;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .chat-header { top: 0; padding-top: 1rem; padding-bottom: 0.5rem; }

        .chat-header.no-blur {
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        .chat-footer, .batch-actions-footer { bottom: 0; padding-bottom: 1rem; padding-top: 0.5rem; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 20px; }
        
        .datetime-display {
            position: absolute;
            top: 3.5rem; /* MODIFIED */
            right: 1.5rem;
            text-align: right;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }
        .time {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .date {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        #diary-btn {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.5rem;
            opacity: 0.8;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 0.25rem;
        }
        #sui-btn {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 20;
            padding: 0.5rem 1rem;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 2px;
            text-shadow: 0 0 8px rgba(255,255,255,0.5);
            background: var(--glass-container-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: var(--text-color);
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        #diary-btn:hover, #sui-btn:hover {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        /* --- 全局颜色应用强化 --- */
        input, textarea, select {
            color: var(--text-color);
        }
        input::placeholder, textarea::placeholder {
            color: var(--text-color);
            opacity: 0.6;
        }
        .mini-player, .diary-content {
            color: var(--text-color);
        }
        .mini-player-container {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            width: calc(100% - 2rem); /* 确保容器不会超出屏幕 */
            display: flex;
            justify-content: center;
        }
        .mini-player {
            width: 300px;
            max-width: 100%; /* 确保播放器本身不会超出容器 */
            background: var(--glass-container-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            /* box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); MODIFIED: Shadow removed */
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        .player-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .player-header h2 { font-size: 12px; font-weight: 600; text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        .import-btn { background: rgba(255, 255, 255, 0.2); border: none; color: inherit; padding: 4px 8px; border-radius: 50px; font-size: 10px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
        .import-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .player-content { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .info-section { flex-grow: 1; min-width: 0; }
        .song-info { margin-bottom: 6px; }
        .song-info h3 { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
        .song-info p { font-size: 10px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .album-art { width: 50px; height: 50px; border-radius: 6px; background: linear-gradient(45deg, #ee9ca7, #ffdde1); overflow: hidden; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255, 255, 255, 0.3); flex-shrink: 0; cursor: pointer; position: relative; transition: all 0.3s ease; }
        .album-art:hover::after { content: '换封面'; position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.7); color: white; font-size: 9px; padding: 2px; text-align: center; }
        .album-art i { font-size: 20px; color: rgba(255, 255, 255, 0.8); }
        .album-art img { width: 100%; height: 100%; object-fit: cover; }
        .progress-area { margin-bottom: 6px; }
        .progress-container { background: rgba(255, 255, 255, 0.2); border-radius: 5px; height: 4px; margin-bottom: 4px; cursor: pointer; position: relative; }
        .progress-bar { background: linear-gradient(90deg, #fff, #c2e9fb); border-radius: 5px; height: 100%; width: 0%; transition: width 0.1s linear; }
        .progress-time { display: flex; justify-content: space-between; font-size: 9px; opacity: 0.8; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; }
        .control-btn { background: none; border: none; color: inherit; font-size: 11px; cursor: pointer; padding: 4px; opacity: 0.8; transition: all 0.2s; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .control-btn:hover { opacity: 1; background: rgba(255, 255, 255, 0.1); }
        .play-pause { background: rgba(255, 255, 255, 0.2); width: 28px; height: 28px; border-radius: 50%; font-size: 11px; }
        .play-pause:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        .volume-container { display: flex; align-items: center; gap: 5px; }
        .volume-container i { font-size: 11px; opacity: 0.8; }
        .volume-slider { -webkit-appearance: none; width: 50px; height: 3px; background: rgba(255, 255, 255, 0.2); border-radius: 5px; outline: none; }
        .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; border-radius: 50%; background: white; cursor: pointer; }
        .file-input, .cover-input { display: none; }
        .playlist-btn { background: none; border: none; color: inherit; font-size: 11px; cursor: pointer; padding: 4px 6px; opacity: 0.8; transition: all 0.2s; border-radius: 4px; }
        .playlist-btn:hover { opacity: 1; background: rgba(255, 255, 255, 0.1); }
        .song-list { margin-top: 10px; text-align: left; max-height: 100px; overflow-y: auto; background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 8px; display: none; }
        .song-list::-webkit-scrollbar { width: 5px; }
        .song-list::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .song-list::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        .song-list::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }
        .song-item { padding: 5px 8px; border-radius: 4px; margin-bottom: 4px; cursor: pointer; transition: background 0.2s; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; user-select: none; }
        .song-item:hover { background: rgba(255, 255, 255, 0.2); }
        .song-item.active { background: rgba(255, 255, 255, 0.3); font-weight: 500; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .rotating { animation: rotate 15s linear infinite; }
        .diary-entry, .memory-item { background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1rem; position: relative; }
        .diary-content strong { font-weight: bold; color: #fcd34d; }
        .diary-content em { font-style: italic; color: #93c5fd; }
        .diary-content del { text-decoration: line-through; opacity: 0.7; }
        .diary-delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; color: inherit; opacity: 0.5; cursor: pointer; transition: opacity 0.2s; }
        .diary-delete-btn:hover { opacity: 1; }
        .batch-delete-checkbox { position: absolute; top: 0.75rem; left: 0.75rem; }
        .form-checkbox { background-color: #4a5568; border-color: #718096; }

        /* --- SUI Page Specific Styles --- */
        .sui-nav-btn {
            color: var(--text-color);
            opacity: 0.6;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; /* Overlap with parent border */
        }
        .sui-nav-btn:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.05);
        }
        .sui-nav-btn.active {
            opacity: 1;
            color: #c4b5fd; /* A highlight color */
            border-bottom-color: #c4b5fd;
        }
        .sui-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 1rem;
        }
        .sui-list {
            padding-right: 8px; /* For scrollbar gap */
        }
        .sui-list-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            position: relative;
        }
        .sui-list-item .timestamp {
            font-size: 0.7rem;
            opacity: 0.6;
            display: block;
            margin-bottom: 4px;
        }
        .sui-list-item .amount-positive { color: #4ade80; }
        .sui-list-item .amount-negative { color: #f87171; }
        .sui-list-item .chat-with { font-weight: bold; color: #93c5fd; }
        /* NEW: Styles for chat log in SUI */
        .sui-chat-log {
            margin-top: 6px;
            padding-left: 10px;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
        }
        .sui-chat-log p {
            margin-bottom: 2px;
            line-height: 1.4;
        }
        .sui-list-item .url { color: #a78bfa; word-break: break-all; }
        /* NEW: Styles for browsing session in SUI */
        .sui-browsing-session {
            margin-top: 6px;
            padding-left: 10px;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
        }
        .sui-browsing-session p {
            margin-bottom: 2px;
            line-height: 1.4;
            font-size: 0.75rem;
        }
        .sui-browsing-session .url {
            opacity: 0.7;
            font-size: 0.7rem;
        }


        /* --- Touch Effect --- */
        .touch-particle {
            position: absolute;
            pointer-events: none;
            z-index: 9999;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.9), 0 0 16px rgba(255, 255, 255, 0.7);
            will-change: transform, opacity;
            transform: translate(-50%, -50%);
        }
        .love-particle {
            font-size: 18px; /* Adjusted size for the full word */
            animation: fade-out-love 0.8s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .trail-particle {
            font-size: 14px; /* Smaller size for the trail */
            animation: fade-out-trail 0.6s forwards ease-out;
        }
        @keyframes fade-out-love {
            from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 0; transform: translate(-50%, -80%) scale(1.5); }
        }
        @keyframes fade-out-trail {
            from { opacity: 0.9; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 0; transform: translate(-50%, -150%) scale(0.8); }
        }
    </style>
</head>
<body>
    <div class="phone-wrapper">
        <div id="phone-frame">
            <div id="phone-screen">
                <div id="app" class="container">
                    <!-- 主页 -->
                    <div id="home-page" class="w-full h-full flex flex-col p-6 transition-all duration-500 relative">
                        <button id="sui-btn" title="核心监控">SUI</button>
                        
                        <div class="datetime-display">
                            <div id="time-display" class="time">00:00:00</div>
                            <div class="flex items-center gap-4">
                                <div id="date-display" class="date">0000年00月00日 星期X</div>
                                <button id="diary-btn" title="TA的日记">
                                    <i class="fa-solid fa-feather-pointed"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="home-content-wrapper" class="w-full flex-1 flex items-center mt-24">
                            <div id="home-avatar-section" class="w-1/2 flex flex-col items-start">
                                <div id="avatar-container" class="relative rounded-full p-1 cursor-pointer w-32 h-32 flex items-center justify-center mb-4">
                                    <img id="avatar-frame" src="" alt="" class="absolute inset-0 w-full h-full object-contain pointer-events-none z-10">
                                    <img id="avatar-img" src="https://placehold.co/120x120/334155/FFFFFF?text=头像" alt="Avatar" class="w-28 h-28 object-cover rounded-full">
                                </div>
                                <input type="file" id="avatar-upload" accept="image/*" class="hidden">
                                <h2 id="signature" class="text-xs font-semibold tracking-wide">个性签名</h2>
                            </div>
                            <div id="home-buttons-section" class="w-1/2 flex flex-col items-end space-y-4">
                                <button id="strategy-btn" class="menu-btn">攻略</button>
                                <button id="memory-btn" class="menu-btn">记忆</button>
                                <button id="role-btn" class="menu-btn">角色</button>
                                <button id="settings-btn" class="menu-btn">设置</button>
                            </div>
                        </div>

                        <!-- Mini Music Player -->
                        <div class="mini-player-container">
                            <div class="mini-player">
                                <audio id="main-audio"></audio>
                                <div class="player-header">
                                    <h2>迷你音乐</h2>
                                    <label for="file-input" class="import-btn">
                                        <i class="fas fa-file-audio"></i> 导入
                                    </label>
                                    <input type="file" id="file-input" class="file-input" accept="audio/*" multiple>
                                </div>
                                <div class="player-content">
                                    <div class="info-section">
                                        <div class="song-info">
                                            <h3 id="song-title">选择一首歌曲</h3>
                                            <p id="song-artist">未知艺术家</p>
                                        </div>
                                        <div class="progress-area">
                                            <div class="progress-container">
                                                <div class="progress-bar"></div>
                                            </div>
                                            <div class="progress-time">
                                                <span id="current-time">0:00</span>
                                                <span id="total-time">0:00</span>
                                            </div>
                                        </div>
                                        <div class="controls">
                                            <button class="control-btn" id="prev"><i class="fas fa-step-backward"></i></button>
                                            <button class="control-btn play-pause" id="play-pause"><i class="fas fa-play"></i></button>
                                            <button class="control-btn" id="next"><i class="fas fa-step-forward"></i></button>
                                            <div class="volume-container">
                                                <i class="fas fa-volume-up"></i>
                                                <input type="range" class="volume-slider" id="volume" min="0" max="1" step="0.01" value="0.7">
                                            </div>
                                            <button class="playlist-btn" id="toggle-playlist"><i class="fas fa-list"></i></button>
                                        </div>
                                    </div>
                                    <label for="cover-input" class="album-art" id="album-art-label">
                                        <i class="fas fa-music"></i>
                                    </label>
                                    <input type="file" id="cover-input" class="cover-input" accept="image/*">
                                </div>
                                <div class="song-list scrollable-content" id="playlist"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 聊天界面 -->
                    <div id="chat-page" class="hidden w-full h-full flex flex-col transition-all duration-500">
                        <div class="chat-header glass-container border-none rounded-b-2xl no-blur">
                            <div class="flex items-center justify-between">
                                <button id="chat-back-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                                <span id="affinity-display" class="text-lg font-semibold">好感度：0/100</span>
                                <div class="flex items-center space-x-2">
                                    <button id="restart-chat-btn" title="新对话" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 00-1 1v4H5a1 1 0 100 2h4v4a1 1 0 102 0v-4h4a1 1 0 100-2h-4V4a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                                    <button id="summarize-memory-btn" title="存档记忆" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12l-3-3-3 3V4z" /></svg></button>
                                </div>
                            </div>
                        </div>
                        <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-2 flex flex-col scrollable-content"></div>
                        <div id="chat-footer" class="chat-footer">
                            <div class="flex items-center space-x-2">
                                <button id="ai-reply-btn" class="px-4 py-3 rounded-xl glass-container font-bold hover:bg-white/20 transition-colors">角色回复</button>
                                <div class="flex-1 relative">
                                    <input type="text" id="user-input" class="w-full p-4 pr-14 rounded-full glass-container border-none outline-none placeholder-gray-300 focus:ring-2 focus:ring-blue-400 transition-shadow duration-300" placeholder="请输入消息...">
                                     <button id="send-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2.5 text-pink-300 hover:text-pink-400 transition-colors duration-300">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="chat-batch-actions" class="batch-actions-footer hidden">
                            <div class="flex w-full space-x-2">
                                <button id="confirm-batch-delete-chat-btn" class="w-full p-3 rounded-md bg-red-600 text-white font-bold hover:bg-red-700 transition-colors">删除选中</button>
                                <button id="cancel-batch-delete-chat-btn" class="w-full p-3 rounded-md bg-gray-600 text-white font-bold hover:bg-gray-700 transition-colors">取消</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 角色设置页面 -->
                    <div id="role-page" class="hidden w-full h-full flex flex-col p-4 overflow-y-auto scrollable-content">
                        <div class="flex items-center justify-between w-full max-w-lg mx-auto mb-4">
                             <button id="role-back-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                            <h1 class="text-2xl font-bold">角色设置</h1>
                            <div class="w-8"></div>
                        </div>
                        <div class="w-full max-w-lg mx-auto space-y-4 pb-8">
                            <div class="glass-container p-4 rounded-xl">
                                <h2 class="text-xl font-bold mb-3">玩家人设</h2>
                                <input type="text" id="player-name" class="w-full p-3 rounded-md bg-white/20 placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="玩家名称">
                                <input type="text" id="player-gender" class="w-full p-3 mt-2 rounded-md bg-white/20 placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="玩家性别">
                                <textarea id="player-persona" class="w-full p-3 mt-2 rounded-md bg-white/20 placeholder-gray-300 focus:outline-none h-24 focus:ring-2 focus:ring-blue-400" placeholder="玩家详细人设、背景故事、性格特点..."></textarea>
                            </div>
                             <div class="glass-container p-4 rounded-xl">
                                <h2 class="text-xl font-bold mb-3">攻略角色人设</h2>
                                <input type="text" id="role-name" class="w-full p-3 rounded-md bg-white/20 placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="攻略角色名称">
                                <input type="text" id="role-gender" class="w-full p-3 mt-2 rounded-md bg-white/20 placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="攻略角色性别">
                                <textarea id="role-persona" class="w-full p-3 mt-2 rounded-md bg-white/20 placeholder-gray-300 focus:outline-none h-32 focus:ring-2 focus:ring-blue-400" placeholder="角色详细人设、背景故事、性格特点..."></textarea>
                            </div>
                             <div class="glass-container p-4 rounded-xl">
                                <h2 class="text-xl font-bold mb-3">AI行为指令</h2>
                                <textarea id="prompt-instructions" class="w-full p-3 rounded-md bg-white/20 placeholder-gray-300 focus:outline-none h-32 focus:ring-2 focus:ring-blue-400" placeholder="给AI的特殊指令, 例如：'请以口语化的方式回复' 或 '在回复中加入表情符号'"></textarea>
                            </div>
                            <button id="save-role-btn" class="w-full p-3 rounded-md bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition-colors duration-300">保存角色设置</button>
                        </div>
                    </div>

                    <!-- 设置页面 -->
                    <div id="settings-page" class="hidden w-full h-full flex-col p-4 overflow-y-auto scrollable-content">
                         <div class="flex items-center justify-between w-full max-w-lg mx-auto mb-4">
                             <button id="settings-back-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                            <h1 class="text-2xl font-bold">设置</h1>
                            <div class="w-8"></div>
                        </div>
                        <div class="glass-container p-6 w-full max-w-lg mx-auto space-y-4">
                            <div class="flex flex-col">
                                <label for="signature-input" class="mb-2">个性签名</label>
                                <input type="text" id="signature-input" class="w-full p-3 rounded-md bg-white/20 placeholder-gray-300 focus:outline-none" placeholder="请输入个性签名...">
                            </div>
                            <div class="mt-6 pt-6 border-t border-white/20">
                                <h2 class="text-xl font-bold mb-4">外观设置</h2>
                                <div class="flex space-x-2">
                                    <button id="avatar-frame-upload-btn" class="flex-grow p-3 rounded-md bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors duration-300">
                                        选择头像框
                                    </button>
                                    <button id="bg-upload-btn" class="flex-grow p-3 rounded-md bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors duration-300">
                                        选择背景图片
                                    </button>
                                    <button id="restore-appearance-btn" title="还原默认" class="p-3 rounded-md bg-gray-600 text-white font-bold hover:bg-gray-700 transition-colors duration-300">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                 </div>
                                 <div class="mt-4">
                                    <button id="fullscreen-btn" class="w-full p-3 rounded-md bg-teal-600 text-white font-bold hover:bg-teal-700 transition-colors duration-300 flex items-center justify-center gap-2">
                                        <i class="fas fa-expand"></i>
                                        <span>全屏</span>
                                    </button>
                                </div>
                             </div>
                             <div class="mt-6 pt-6 border-t border-white/20">
                                <h2 class="text-xl font-bold mb-4">字体设置</h2>
                                <div class="flex flex-col mb-2">
                                    <label for="font-upload" class="mb-2">上传自定义字体</label>
                                    <input type="file" id="font-upload" accept=".ttf,.otf,.woff,.woff2" class="w-full p-3 rounded-md bg-white/20 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                </div>
                                <div class="flex space-x-2 mb-2">
                                    <button id="manage-fonts-btn" class="flex-grow p-2 rounded-md bg-gray-600 text-white text-sm font-bold hover:bg-gray-700 transition-colors">管理字体</button>
                                </div>
                                <div class="flex items-center justify-between mb-2">
                                    <label for="font-family-select">选择字体</label>
                                    <select id="font-family-select" class="w-48 p-2 rounded-md bg-white/20">
                                        <option value="'Inter', sans-serif">默认字体 (Inter)</option>
                                        <option value="'Arial', sans-serif">Arial</option>
                                        <option value="'Times New Roman', serif">Times New Roman</option>
                                        <option value="'Courier New', monospace">Courier New</option>
                                        <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                                    </select>
                                </div>
                             </div>
                             <div class="mt-6 pt-6 border-t border-white/20">
                                <h2 class="text-xl font-bold mb-4">主题设置</h2>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                                    <div class="flex items-center justify-between"><label for="theme-bg-color">背景色</label><input type="color" id="theme-bg-color" class="w-12 h-8 rounded-md bg-transparent border-none"></div>
                                    <div class="flex items-center justify-between"><label for="theme-text-color">文字颜色</label><input type="color" id="theme-text-color" class="w-12 h-8 rounded-md bg-transparent border-none"></div>
                                    <div class="flex items-center justify-between"><label for="theme-glass-bg">玻璃容器</label><input type="color" id="theme-glass-bg" class="w-12 h-8 rounded-md bg-transparent border-none"></div>
                                    <div class="flex items-center justify-between"><label for="theme-user-bubble">用户气泡</label><input type="color" id="theme-user-bubble" class="w-12 h-8 rounded-md bg-transparent border-none"></div>
                                    <div class="flex items-center justify-between"><label for="theme-ai-bubble">AI气泡</label><input type="color" id="theme-ai-bubble" class="w-12 h-8 rounded-md bg-transparent border-none"></div>
                                    <div class="flex items-center justify-between"><label for="theme-user-text">用户文字</label><input type="color" id="theme-user-text" class="w-12 h-8 rounded-md bg-transparent border-none"></div>
                                    <div class="flex items-center justify-between"><label for="theme-ai-text">AI文字</label><input type="color" id="theme-ai-text" class="w-12 h-8 rounded-md bg-transparent border-none"></div>
                                </div>
                             </div>
                            <div class="mt-6 pt-6 border-t border-white/20">
                                <h2 class="text-xl font-bold mb-4">API 设置</h2>
                                <input type="text" id="api-baseurl" class="w-full p-3 rounded-md bg-white/20 placeholder-gray-300 focus:outline-none" placeholder="API Base URL (例如: https://api.openai.com/v1)">
                                <input type="text" id="api-key" class="w-full p-3 mt-2 rounded-md bg-white/20 placeholder-gray-300 focus:outline-none" placeholder="API 密钥">
                                <input type="text" id="api-model" class="w-full p-3 mt-2 rounded-md bg-white/20 placeholder-gray-300 focus:outline-none" placeholder="模型名称 (例如: gpt-3.5-turbo)">
                            </div>
                            <div class="mt-6 pt-6 border-t border-white/20">
                                <h2 class="text-xl font-bold mb-4">数据管理</h2>
                                <div class="flex space-x-4">
                                    <button id="export-data-btn" class="w-full p-3 rounded-md bg-green-600 text-white font-bold hover:bg-green-700 transition-colors duration-300">导出数据</button>
                                    <button id="import-data-btn" class="w-full p-3 rounded-md bg-yellow-600 text-white font-bold hover:bg-yellow-700 transition-colors duration-300">导入数据</button>
                                </div>
                                <input type="file" id="import-file-input" class="hidden" accept=".json">
                            </div>
                            <button id="save-settings-btn" class="w-full p-3 rounded-md bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition-colors duration-300 mt-4">保存所有设置</button>
                        </div>
                    </div>
                    
                    <!-- 记忆页面 -->
                    <div id="memory-page" class="hidden w-full h-full flex flex-col p-4">
                        <div class="flex items-center justify-between w-full max-w-lg mx-auto mb-4">
                             <button id="memory-back-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                            <h1 class="text-2xl font-bold">记忆存档</h1>
                            <div class="flex items-center space-x-2">
                                <button id="batch-delete-memories-btn" title="批量删除" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300"><i class="fas fa-trash-alt"></i></button>
                                <button id="add-memory-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 00-1 1v4H5a1 1 0 100 2h4v4a1 1 0 102 0v-4h4a1 1 0 100-2h-4V4a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                            </div>
                        </div>
                        <div id="memory-list" class="glass-container p-4 w-full max-w-lg mx-auto flex-1 overflow-y-auto space-y-2 scrollable-content"></div>
                        <div id="memory-batch-actions" class="hidden w-full max-w-lg mx-auto mt-4 flex space-x-2">
                            <button id="confirm-batch-delete-memories-btn" class="w-full p-3 rounded-md bg-red-600 text-white font-bold hover:bg-red-700 transition-colors">删除选中</button>
                            <button id="cancel-batch-delete-memories-btn" class="w-full p-3 rounded-md bg-gray-600 text-white font-bold hover:bg-gray-700 transition-colors">取消</button>
                        </div>
                    </div>

                    <!-- 日记页面 -->
                    <div id="diary-page" class="hidden w-full h-full flex flex-col p-4">
                        <div class="flex items-center justify-between w-full max-w-2xl mx-auto mb-4">
                            <button id="diary-back-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                            <h1 class="text-2xl font-bold">TA的日记</h1>
                            <div class="flex items-center space-x-2">
                                <button id="generate-diary-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300" title="生成新日记"><i class="fas fa-pen-nib"></i></button>
                                <button id="batch-delete-diaries-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300" title="批量删除"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div id="diary-list-container" class="glass-container p-4 w-full max-w-2xl mx-auto flex-1 overflow-y-auto space-y-4 scrollable-content"></div>
                        <div id="diary-batch-actions" class="hidden w-full max-w-2xl mx-auto mt-4 flex space-x-2">
                            <button id="confirm-batch-delete-diaries-btn" class="w-full p-3 rounded-md bg-red-600 text-white font-bold hover:bg-red-700 transition-colors">删除选中</button>
                            <button id="cancel-batch-delete-btn" class="w-full p-3 rounded-md bg-gray-600 text-white font-bold hover:bg-gray-700 transition-colors">取消</button>
                        </div>
                    </div>

                    <!-- SUI 核心监控页面 -->
                    <div id="sui-page" class="hidden w-full h-full flex flex-col p-4">
                        <div class="flex items-center justify-between w-full max-w-2xl mx-auto mb-4">
                            <button id="sui-back-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                            <h1 class="text-2xl font-bold">核心监控</h1>
                            <button id="sui-clear-btn" title="清空记录" class="p-2 rounded-full hover:bg-white/10 transition-colors duration-300"><i class="fas fa-broom"></i></button>
                        </div>
                        
                        <!-- SUI Navigation Tabs -->
                        <div id="sui-nav" class="w-full max-w-2xl mx-auto flex mb-4 border-b border-white/20">
                            <button data-target="sui-account-section" class="sui-nav-btn flex-1 py-2 text-center font-semibold transition-colors duration-300 active">账户信息</button>
                            <button data-target="sui-comms-section" class="sui-nav-btn flex-1 py-2 text-center font-semibold transition-colors duration-300">外部通讯</button>
                            <button data-target="sui-browsing-section" class="sui-nav-btn flex-1 py-2 text-center font-semibold transition-colors duration-300">浏览记录</button>
                        </div>

                        <!-- SUI Content Sections -->
                        <div class="w-full max-w-2xl mx-auto flex-1 overflow-y-auto scrollable-content">
                            <!-- Account Section -->
                            <div id="sui-account-section" class="sui-content-section">
                                <div class="sui-section">
                                    <h2 class="text-xl font-bold mb-3">账户详情</h2>
                                    <p class="mb-2">当前余额: <span id="sui-balance" class="font-mono text-lg text-amber-300">0.00</span></p>
                                    <h3 class="text-md font-semibold mb-2 border-t border-white/10 pt-2">交易记录</h3>
                                    <div id="sui-transactions-list" class="sui-list">
                                        <p class="opacity-70 text-center">暂无记录</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Comms Section -->
                            <div id="sui-comms-section" class="sui-content-section hidden">
                                <div class="sui-section">
                                    <!-- MODIFIED: h2 removed -->
                                    <div id="sui-other-chats-list" class="sui-list">
                                        <p class="opacity-70 text-center">暂无记录</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Browsing Section -->
                            <div id="sui-browsing-section" class="sui-content-section hidden">
                                <div class="sui-section">
                                    <!-- MODIFIED: h2 removed -->
                                    <div id="sui-browsing-history-list" class="sui-list">
                                        <p class="opacity-70 text-center">暂无记录</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- 自定义弹窗 -->
                    <div id="custom-dialog" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
                        <div class="glass-container p-6 shadow-xl w-full max-w-sm border-none">
                            <h3 id="dialog-title" class="text-xl font-bold mb-4"></h3>
                            <div id="dialog-message" class="mb-4"></div>
                            <div id="dialog-input-container" class="mb-4 hidden">
                                <textarea id="dialog-input" class="w-full p-2 border-none rounded-md bg-white/20 h-24"></textarea>
                            </div>
                            <div id="dialog-buttons" class="flex justify-end space-x-2"></div>
                        </div>
                    </div>
                    <input type="file" id="bg-upload-input" accept="image/*" class="hidden">
                    <input type="file" id="avatar-frame-upload-input" accept="image/*" class="hidden">
                </div>
            </div>
        </div>
    </div>

    <script>
        (async () => { // Wrap in an async IIFE to use top-level await
            const get = id => document.getElementById(id);
            const APP_VERSION = "2.9.0"; // Version with full SUI memory implantation

            // --- IndexedDB Helper ---
            const db = {
                _db: null,
                init: function(dbName, storeName) {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open(dbName, 1);
                        request.onerror = () => reject("IndexedDB error: " + request.error);
                        request.onsuccess = (event) => { this._db = event.target.result; resolve(this); };
                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            if (!db.objectStoreNames.contains(storeName)) {
                                db.createObjectStore(storeName);
                            }
                        };
                    });
                },
                set: function(storeName, key, value) {
                    return new Promise((resolve, reject) => {
                        if (!this._db) return reject("DB not initialized");
                        try {
                            const transaction = this._db.transaction([storeName], 'readwrite');
                            const store = transaction.objectStore(storeName);
                            const request = store.put(value, key);
                            request.onsuccess = () => resolve();
                            request.onerror = () => reject("Failed to save to DB: " + request.error);
                        } catch (e) { reject(e); }
                    });
                },
                get: function(storeName, key) {
                    return new Promise((resolve, reject) => {
                        if (!this._db) return reject("DB not initialized");
                        const transaction = this._db.transaction([storeName]);
                        const store = transaction.objectStore(storeName);
                        const request = store.get(key);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject("Failed to get from DB: " + request.error);
                    });
                },
                delete: function(storeName, key) {
                    return new Promise((resolve, reject) => {
                        if (!this._db) return reject("DB not initialized");
                        const transaction = this._db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.delete(key);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject("Failed to delete from DB: " + request.error);
                    });
                }
            };
            await db.init('GameDataStore', 'assets');

            let loadedFontFaces = new Set();

            // Page elements
            const phoneScreen = get('phone-screen');
            const pages = { home: get('home-page'), chat: get('chat-page'), role: get('role-page'), settings: get('settings-page'), memory: get('memory-page'), diary: get('diary-page'), sui: get('sui-page') };

            // Buttons
            const strategyBtn = get('strategy-btn'), memoryBtn = get('memory-btn'), roleBtn = get('role-btn'), settingsBtn = get('settings-btn'), saveRoleBtn = get('save-role-btn'), saveSettingsBtn = get('save-settings-btn');
            const backBtns = document.querySelectorAll('#chat-back-btn, #role-back-btn, #settings-back-btn, #memory-back-btn, #diary-back-btn, #sui-back-btn');
            const exportDataBtn = get('export-data-btn'), importDataBtn = get('import-data-btn'), importFileInput = get('import-file-input'), diaryBtn = get('diary-btn'), suiBtn = get('sui-btn');
            const fullscreenBtn = get('fullscreen-btn');

            // Home page elements
            const avatarContainer = get('avatar-container'), avatarImg = get('avatar-img'), avatarFrame = get('avatar-frame'), avatarUpload = get('avatar-upload');
            const signatureDisplay = get('signature'), timeDisplay = get('time-display'), dateDisplay = get('date-display');

            // Chat elements
            const chatHistory = get('chat-history'), userInput = get('user-input'), sendBtn = get('send-btn'), aiReplyBtn = get('ai-reply-btn');
            const restartChatBtn = get('restart-chat-btn'), summarizeMemoryBtn = get('summarize-memory-btn'), affinityDisplay = get('affinity-display'), chatFooter = get('chat-footer');
            const chatBatchActions = get('chat-batch-actions'), confirmBatchDeleteChatBtn = get('confirm-batch-delete-chat-btn'), cancelBatchDeleteChatBtn = get('cancel-batch-delete-chat-btn');
            let isChatBatchDeleteMode = false;

            // Memory elements
            const memoryListEl = get('memory-list'), addMemoryBtn = get('add-memory-btn'), batchDeleteMemoriesBtn = get('batch-delete-memories-btn');
            const memoryBatchActions = get('memory-batch-actions'), confirmBatchDeleteMemoriesBtn = get('confirm-batch-delete-memories-btn'), cancelBatchDeleteMemoriesBtn = get('cancel-batch-delete-memories-btn');
            let isMemoryBatchDeleteMode = false;
            
            // Diary elements
            const diaryListContainer = get('diary-list-container'), generateDiaryBtn = get('generate-diary-btn'), batchDeleteDiariesBtn = get('batch-delete-diaries-btn');
            const diaryBatchActions = get('diary-batch-actions'), confirmBatchDeleteBtn = get('confirm-batch-delete-diaries-btn'), cancelBatchDeleteBtn = get('cancel-batch-delete-btn');
            let isDiaryBatchDeleteMode = false;

            // SUI elements
            let suiBalanceEl = get('sui-balance'), suiTransactionsListEl = get('sui-transactions-list'), suiOtherChatsListEl = get('sui-other-chats-list'), suiBrowsingHistoryListEl = get('sui-browsing-history-list');
            const suiNav = get('sui-nav'), suiNavBtns = document.querySelectorAll('.sui-nav-btn'), suiContentSections = document.querySelectorAll('.sui-content-section');
            const suiClearBtn = get('sui-clear-btn');

            // Dialog elements
            const dialog = get('custom-dialog'), dialogTitle = get('dialog-title'), dialogMessage = get('dialog-message');
            const dialogInputContainer = get('dialog-input-container'), dialogInput = get('dialog-input'), dialogButtons = get('dialog-buttons');
            
            // Settings Elements
            const themeBgColor = get('theme-bg-color'), themeTextColor = get('theme-text-color'), themeGlassBg = get('theme-glass-bg'), themeUserBubble = get('theme-user-bubble');
            const themeAiBubble = get('theme-ai-bubble'), themeUserText = get('theme-user-text'), themeAiText = get('theme-ai-text');
            const fontUpload = get('font-upload'), fontFamilySelect = get('font-family-select'), manageFontsBtn = get('manage-fonts-btn'), bgUploadBtn = get('bg-upload-btn'), bgUploadInput = get('bg-upload-input');
            const avatarFrameUploadBtn = get('avatar-frame-upload-btn'), avatarFrameUploadInput = get('avatar-frame-upload-input'), restoreAppearanceBtn = get('restore-appearance-btn');
            const apiBaseUrl = get('api-baseurl'), apiKey = get('api-key'), apiModel = get('api-model');

            const state = {
                version: APP_VERSION,
                config: { bgImage: null, avatarImage: null, avatarFrameImage: null, signature: '个性签名', api: { baseUrl: '', key: '', model: '' }, colors: { bgColor: '#1a202c', textColor: '#ffffff', glassBg: 'rgba(255, 255, 255, 0.15)', userBubble: 'rgba(60, 179, 113, 0.7)', userText: '#ffffff', aiBubble: 'rgba(255, 255, 255, 0.8)', aiText: '#000000', }, fontFamily: "'Inter', sans-serif", customFonts: {} },
                role: { playerName: '', playerGender: '', playerPersona: '', roleName: '', roleGender: '', rolePersona: '', promptInstructions: '' },
                chat: { history: [], affinity: 0 },
                memories: [],
                diaries: [],
                sui: { isInitialized: false, balance: 0, transactions: [], otherChats: [], browsingHistory: [] },
                music: { playlist: [], currentSongIndex: -1, albumArt: null, volume: 0.7 }
            };
            
            const applyColors = (colors) => {
                document.documentElement.style.setProperty('--bg-color', colors.bgColor); document.documentElement.style.setProperty('--text-color', colors.textColor);
                document.documentElement.style.setProperty('--glass-container-bg', colors.glassBg); document.documentElement.style.setProperty('--user-bubble-bg', colors.userBubble);
                document.documentElement.style.setProperty('--user-bubble-text', colors.userText); document.documentElement.style.setProperty('--ai-bubble-bg', colors.aiBubble);
                document.documentElement.style.setProperty('--ai-bubble-text', colors.aiText); phoneScreen.style.backgroundColor = colors.bgColor;
            };
            
            const applyFont = async (fontName) => {
                if (state.config.customFonts[fontName]) {
                    if (loadedFontFaces.has(fontName)) {
                        document.documentElement.style.setProperty('--custom-font', `'${fontName}', sans-serif`);
                        return;
                    }
                    try {
                        const fontData = await db.get('assets', `font-${fontName}`);
                        if (!fontData) throw new Error(`Font data for '${fontName}' not found in DB.`);
                        const fontFace = new FontFace(fontName, `url(${fontData})`);
                        await fontFace.load();
                        document.fonts.add(fontFace);
                        loadedFontFaces.add(fontName);
                        document.documentElement.style.setProperty('--custom-font', `'${fontName}', sans-serif`);
                    } catch (error) {
                        console.error('Custom font failed to load:', error);
                        document.documentElement.style.setProperty('--custom-font', "'Inter', sans-serif"); // Fallback
                    }
                } else {
                    document.documentElement.style.setProperty('--custom-font', fontName);
                }
            };
            
            const renderFontOptions = () => {
                const customFontOptions = fontFamilySelect.querySelectorAll('option.custom-font-option');
                customFontOptions.forEach(opt => opt.remove());

                for (const fontName in state.config.customFonts) {
                    const option = document.createElement('option');
                    option.value = fontName;
                    option.textContent = fontName;
                    option.className = 'custom-font-option';
                    fontFamilySelect.appendChild(option);
                }
            };

            const ASSET_KEYS = {
                'bgImage': (s) => s.config.bgImage,
                'avatarImage': (s) => s.config.avatarImage,
                'avatarFrameImage': (s) => s.config.avatarFrameImage,
                'albumArt': (s) => s.music.albumArt
            };
            const setAssetValue = (obj, key, value) => {
                if (key === 'albumArt') obj.music.albumArt = value;
                else obj.config[key] = value;
            };

            async function saveState() {
                try {
                    state.version = APP_VERSION;
                    const stateToSave = JSON.parse(JSON.stringify(state));

                    // Handle single assets
                    for (const key in ASSET_KEYS) {
                        const assetData = ASSET_KEYS[key](stateToSave);
                        if (assetData && assetData.startsWith('data:')) {
                            await db.set('assets', key, assetData);
                            setAssetValue(stateToSave, key, 'indexed');
                        } else if (!assetData) {
                            await db.delete('assets', key).catch(e => console.warn(`Could not delete ${key} from DB`, e));
                        }
                    }

                    // Handle custom fonts collection
                    for (const fontName in stateToSave.config.customFonts) {
                        const fontData = stateToSave.config.customFonts[fontName];
                        if (fontData && fontData.startsWith('data:')) {
                            await db.set('assets', `font-${fontName}`, fontData);
                            stateToSave.config.customFonts[fontName] = 'indexed';
                        }
                    }
                    
                    // Strip audio data from playlist before saving to localStorage
                    if (stateToSave.music && stateToSave.music.playlist) {
                        stateToSave.music.playlist = stateToSave.music.playlist.map(song => ({ name: song.name }));
                    }
                    localStorage.setItem('game_state_v5', JSON.stringify(stateToSave));
                } catch (e) {
                    console.error("Failed to save state.", e);
                    showDialog("保存失败", "数据无法保存，可能是浏览器存储空间已满。");
                }
            };

            async function loadState() {
                let savedState = null;
                try {
                    const rawState = localStorage.getItem('game_state_v5');
                    if(rawState) savedState = JSON.parse(rawState);
                } catch (e) { 
                    console.error("Failed to parse state from localStorage, possibly corrupt data.", e);
                    localStorage.removeItem('game_state_v5');
                }

                if (savedState) {
                    // Create a deep copy of the default state to use as a structural base.
                    const defaultState = JSON.parse(JSON.stringify(state));

                    // Start with a shallow merge. This is fast but can break nested objects.
                    const mergedState = { ...defaultState, ...savedState };

                    // Now, explicitly and robustly re-merge the nested objects that are known to be problematic.
                    // This pattern handles cases where savedState.key is null, undefined, or an incomplete object from an older version.
                    mergedState.config = { ...defaultState.config, ...(savedState.config || {}) };
                    mergedState.config.colors = { ...defaultState.config.colors, ...(savedState.config?.colors || {}) };
                    mergedState.role = { ...defaultState.role, ...(savedState.role || {}) };
                    mergedState.sui = { ...defaultState.sui, ...(savedState.sui || {}) };
                    mergedState.music = { ...defaultState.music, ...(savedState.music || {}) };

                    // Overwrite the global state object with the correctly and safely merged one.
                    Object.assign(state, mergedState);
                }
                
                // Load single assets from IndexedDB
                for (const key in ASSET_KEYS) {
                    if (ASSET_KEYS[key](state) === 'indexed') {
                        const data = await db.get('assets', key);
                        if (data) setAssetValue(state, key, data);
                    }
                }
                
                if (state.config.bgImage) phoneScreen.style.backgroundImage = `url(${state.config.bgImage})`;
                if (state.config.avatarImage) avatarImg.src = state.config.avatarImage;
                if (state.config.avatarFrameImage) avatarFrame.src = state.config.avatarFrameImage;
                
                signatureDisplay.textContent = state.config.signature;
                applyColors(state.config.colors);
                renderFontOptions();
                await applyFont(state.config.fontFamily);
                
                initMusicPlayer();
                renderChatHistory();
                renderMemoryList();
                renderDiaryList();
                renderSuiPage();
            };

            const showView = (view) => {
                Object.values(pages).forEach(p => p.classList.add('hidden'));
                if(pages[view]) pages[view].classList.remove('hidden');
            };

            const showDialog = (title, message, options = {}) => {
                return new Promise((resolve) => {
                    dialogTitle.textContent = title; 
                    if (typeof message === 'string') {
                        dialogMessage.innerHTML = message;
                    } else { // It's a node
                        dialogMessage.innerHTML = '';
                        dialogMessage.appendChild(message);
                    }
                    dialogButtons.innerHTML = '';
                    dialogInputContainer.classList.toggle('hidden', !options.input);
                    if (options.input) {
                        dialogInput.value = options.defaultValue || '';
                        dialogInput.placeholder = options.placeholder || '';
                    }

                    const buttons = options.buttons || [{ text: '取消', value: false, class: 'bg-gray-500/50' }, { text: '确定', value: true, class: 'bg-blue-500' }];
                    buttons.forEach(btnInfo => {
                        const button = document.createElement('button');
                        button.textContent = btnInfo.text;
                        // Buttons inside dialog should have their own explicit text color for readability
                        button.className = `px-4 py-2 text-white rounded-md ${btnInfo.class}`;
                        button.onclick = () => {
                            dialog.classList.add('hidden'); dialog.style.display = 'none';
                            let result;
                            if (options.getValues) {
                                result = btnInfo.value === false ? false : options.getValues();
                            } else {
                                result = options.input ? (btnInfo.value === false ? false : dialogInput.value) : btnInfo.value;
                            }
                            resolve(result);
                        };
                        dialogButtons.appendChild(button);
                    });
                    dialog.classList.remove('hidden'); dialog.style.display = 'flex';
                    if (options.input) dialogInput.focus();
                });
            };

            const showToast = (message) => {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-black bg-opacity-70 text-white px-4 py-2 rounded-full shadow-lg transition-opacity duration-300 z-50 opacity-0';
                document.body.appendChild(toast);
                setTimeout(() => toast.classList.remove('opacity-0'), 10);
                setTimeout(() => { toast.classList.add('opacity-0'); setTimeout(() => toast.remove(), 300); }, 2000);
            };
            
            const updateDateTime = () => {
                const now = new Date();
                timeDisplay.textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                dateDisplay.textContent = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            };
            
            updateDateTime(); setInterval(updateDateTime, 1000);

            // --- Touch Effect Initialization ---
            const initTouchEffects = () => {
                let isDragging = false;
                let letterIndex = 0;
                const letters = ['L', 'O', 'V', 'E'];
                let lastParticleTime = 0;
                const particleInterval = 30; // ms

                const createParticle = (x, y, type) => {
                    const particle = document.createElement('div');
                    if (type === 'love') {
                        particle.className = 'touch-particle love-particle';
                        particle.textContent = 'LOVE';
                    } else {
                        particle.className = 'touch-particle trail-particle';
                        particle.textContent = letters[letterIndex];
                        letterIndex = (letterIndex + 1) % letters.length;
                    }
                    particle.style.left = `${x}px`;
                    particle.style.top = `${y}px`;
                    phoneScreen.appendChild(particle);
                    particle.addEventListener('animationend', () => particle.remove());
                };

                const getCoords = (e) => {
                    const rect = phoneScreen.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    return { x: clientX - rect.left, y: clientY - rect.top };
                };
                
                const isInteractive = (target) => {
                    return target.closest('button, a, input, select, textarea, .message-bubble, .progress-container, .album-art, .song-item, [role="button"], [onclick]');
                };

                const handlePointerDown = (e) => {
                    if (isInteractive(e.target)) return;
                    isDragging = true;
                    // Create the initial "LOVE" particle on click
                    const { x, y } = getCoords(e);
                    createParticle(x, y, 'love');
                };

                const handlePointerMove = (e) => {
                    if (!isDragging) return;
                    const now = Date.now();
                    if (now - lastParticleTime < particleInterval) return;
                    lastParticleTime = now;
                    const { x, y } = getCoords(e);
                    createParticle(x, y, 'trail');
                };

                const handlePointerUp = () => { isDragging = false; };

                phoneScreen.addEventListener('mousedown', handlePointerDown);
                phoneScreen.addEventListener('mousemove', handlePointerMove);
                window.addEventListener('mouseup', handlePointerUp);
                phoneScreen.addEventListener('touchstart', handlePointerDown);
                phoneScreen.addEventListener('touchmove', handlePointerMove);
                phoneScreen.addEventListener('touchend', handlePointerUp);
                phoneScreen.addEventListener('touchcancel', handlePointerUp);
            };
            
            // --- Music Player ---
            function initMusicPlayer() {
                const audio = get('main-audio'), playPauseBtn = get('play-pause'), prevBtn = get('prev'), nextBtn = get('next'), volumeSlider = get('volume');
                const progressContainer = document.querySelector('.progress-container'), progressBar = document.querySelector('.progress-bar');
                const currentTimeEl = get('current-time'), totalTimeEl = get('total-time'), songTitle = get('song-title'), songArtist = get('song-artist');
                const albumArtLabel = get('album-art-label'), fileInput = get('file-input'), coverInput = get('cover-input'), playlistEl = get('playlist'), togglePlaylistBtn = get('toggle-playlist');
                let isPlaying = false;
                
                function renderPlaylist() {
                    playlistEl.innerHTML = ''; if (!state.music.playlist || state.music.playlist.length === 0) return;
                    state.music.playlist.forEach((song, index) => {
                        const songItem = document.createElement('div'); songItem.className = 'song-item'; songItem.textContent = song.name;
                        songItem.addEventListener('click', () => { loadSong(index, true); });
                        let pressTimer;
                        songItem.addEventListener('mousedown', () => { pressTimer = setTimeout(() => managePlaylistItem(index), 750); });
                        songItem.addEventListener('mouseup', () => clearTimeout(pressTimer)); songItem.addEventListener('mouseleave', () => clearTimeout(pressTimer));
                        songItem.addEventListener('touchstart', () => { pressTimer = setTimeout(() => managePlaylistItem(index), 750); }, { passive: true });
                        songItem.addEventListener('touchend', () => clearTimeout(pressTimer));
                        playlistEl.appendChild(songItem);
                    });
                }

                async function managePlaylistItem(index) {
                    const song = state.music.playlist[index]; if (!song) return;
                    const confirmed = await showDialog('管理歌曲', `确定要从列表中移除 "${song.name}" 吗？这会从数据库中删除该歌曲文件。`, { buttons: [{text: '取消', value: false, class: 'bg-gray-500/50'}, {text: '移除', value: true, class: 'bg-red-500/80'}] });
                    if (confirmed) {
                        const wasPlaying = (index === state.music.currentSongIndex); const removedSongName = state.music.playlist[index].name;
                        await db.delete('assets', `music-${removedSongName}`);
                        if (index < state.music.currentSongIndex) state.music.currentSongIndex--;
                        state.music.playlist.splice(index, 1);
                        if (wasPlaying) { audio.pause(); audio.src = ''; state.music.currentSongIndex = -1; songTitle.textContent = '选择一首歌曲'; songArtist.textContent = '未知艺术家'; currentTimeEl.textContent = '0:00'; totalTimeEl.textContent = '0:00'; albumArtLabel.classList.remove('rotating'); playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; }
                        await saveState(); renderPlaylist();
                        if(state.music.currentSongIndex !== -1) { const activeSongEl = playlistEl.children[state.music.currentSongIndex]; if (activeSongEl) activeSongEl.classList.add('active'); }
                        showToast('歌曲已移除');
                    }
                }
                
                async function loadSong(index, play = false) {
                    if (!state.music.playlist || index < 0 || index >= state.music.playlist.length) return;
                    state.music.currentSongIndex = index; const song = state.music.playlist[index]; const songData = await db.get('assets', `music-${song.name}`);
                    if (!songData) { showToast(`歌曲数据丢失: ${song.name}`); songTitle.textContent = song.name; songArtist.textContent = '数据丢失'; return; }
                    songTitle.textContent = song.name; songArtist.textContent = '本地音乐'; audio.src = songData;
                    playlistEl.querySelectorAll('.song-item').forEach((item, idx) => item.classList.toggle('active', idx === index));
                    if (play) audio.play();
                    saveState();
                }

                function togglePlay() {
                    if (state.music.playlist.length === 0) { showToast('请先导入音乐'); fileInput.click(); return; }
                    if (audio.paused) { if (!audio.src && state.music.currentSongIndex !== -1) loadSong(state.music.currentSongIndex, true); else if (!audio.src) loadSong(0, true); else audio.play(); } else { audio.pause(); }
                }

                audio.onplay = () => { isPlaying = true; playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; albumArtLabel.classList.add('rotating'); };
                audio.onpause = () => { isPlaying = false; playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; albumArtLabel.classList.remove('rotating'); };
                audio.onended = () => nextSong();
                function updateProgress() { const { currentTime, duration } = audio; if (duration) { progressBar.style.width = `${(currentTime / duration) * 100}%`; currentTimeEl.textContent = formatTime(currentTime); totalTimeEl.textContent = formatTime(duration); } }
                function setProgress(e) { if (state.music.playlist.length === 0 || !audio.duration) return; audio.currentTime = (e.offsetX / this.clientWidth) * audio.duration; }
                function formatTime(seconds) { if (isNaN(seconds)) return '0:00'; const minutes = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60); return `${minutes}:${secs < 10 ? '0' : ''}${secs}`; }
                const prevSong = () => { if (state.music.playlist.length === 0) return; loadSong((state.music.currentSongIndex - 1 + state.music.playlist.length) % state.music.playlist.length, true); };
                const nextSong = () => { if (state.music.playlist.length === 0) return; loadSong((state.music.currentSongIndex + 1) % state.music.playlist.length, true); };
                const setVolume = async () => { audio.volume = volumeSlider.value; state.music.volume = audio.volume; await saveState(); };

                async function handleFileSelect(e) {
                    const files = Array.from(e.target.files); if (files.length === 0) return; showToast(`正在处理 ${files.length} 首歌曲...`);
                    let firstNewSongIndex = -1;
                    for (const file of files) {
                        const songName = file.name.replace(/\.[^/.]+$/, ""); const reader = new FileReader();
                        const promise = new Promise((resolve, reject) => {
                            reader.onload = async (event) => {
                                try { const dataUrl = event.target.result; await db.set('assets', `music-${songName}`, dataUrl); const existingSongIndex = state.music.playlist.findIndex(s => s.name === songName); if (existingSongIndex === -1) { state.music.playlist.push({ name: songName }); if (firstNewSongIndex === -1) { firstNewSongIndex = state.music.playlist.length - 1; } } resolve(); } catch (err) { reject(err); }
                            };
                            reader.onerror = reject; reader.readAsDataURL(file);
                        });
                        await promise;
                    }
                    renderPlaylist(); showToast('歌曲处理完成！');
                    if (!isPlaying && firstNewSongIndex !== -1) { loadSong(firstNewSongIndex, true); }
                    await saveState();
                }
                async function handleCoverSelect(e) {
                    const file = e.target.files[0]; if (!file || !file.type.match('image.*')) return; const reader = new FileReader();
                    reader.onload = async event => { const dataUrl = event.target.result; state.music.albumArt = dataUrl; albumArtLabel.innerHTML = `<img src="${dataUrl}" alt="album art">`; await saveState(); };
                    reader.readAsDataURL(file);
                }

                renderPlaylist(); 
                if (state.music.albumArt) albumArtLabel.innerHTML = `<img src="${state.music.albumArt}" alt="album art">`;
                if (state.music.currentSongIndex > -1) { const song = state.music.playlist[state.music.currentSongIndex]; if(song) { songTitle.textContent = song.name; songArtist.textContent = '本地音乐'; } }
                volumeSlider.value = state.music.volume; audio.volume = state.music.volume;
                playPauseBtn.addEventListener('click', togglePlay); prevBtn.addEventListener('click', prevSong); nextBtn.addEventListener('click', nextSong);
                audio.addEventListener('timeupdate', updateProgress); progressContainer.addEventListener('click', setProgress); volumeSlider.addEventListener('input', setVolume);
                fileInput.addEventListener('change', handleFileSelect); coverInput.addEventListener('change', handleCoverSelect);
                togglePlaylistBtn.addEventListener('click', () => { playlistEl.style.display = (playlistEl.style.display === 'block') ? 'none' : 'block'; });
            }

            // --- Navigation & Page Setup ---
            strategyBtn.addEventListener('click', () => { showView('chat'); setTimeout(() => { chatHistory.scrollTop = chatHistory.scrollHeight; }, 0); });
            memoryBtn.addEventListener('click', () => { renderMemoryList(); showView('memory'); });
            diaryBtn.addEventListener('click', () => { renderDiaryList(); showView('diary'); });
            suiBtn.addEventListener('click', () => {
                try {
                    renderSuiPage();
                    // Reset to the first tab view
                    suiNavBtns.forEach((btn, index) => btn.classList.toggle('active', index === 0));
                    suiContentSections.forEach((section, index) => section.classList.toggle('hidden', index !== 0));
                    showView('sui');
                } catch (e) {
                    console.error("Error opening SUI page:", e);
                    showDialog("页面错误", "无法打开核心监控页面，可能存在损坏的数据。错误详情已记录在控制台。");
                }
            });
            roleBtn.addEventListener('click', () => { get('player-name').value = state.role.playerName; get('player-gender').value = state.role.playerGender; get('player-persona').value = state.role.playerPersona; get('role-name').value = state.role.roleName; get('role-gender').value = state.role.roleGender; get('role-persona').value = state.role.rolePersona; get('prompt-instructions').value = state.role.promptInstructions; showView('role'); });
            settingsBtn.addEventListener('click', () => { get('signature-input').value = state.config.signature; apiBaseUrl.value = state.config.api.baseUrl; apiKey.value = state.config.api.key; apiModel.value = state.config.api.model; themeBgColor.value = state.config.colors.bgColor; themeTextColor.value = state.config.colors.textColor; themeGlassBg.value = rgbaToHex(state.config.colors.glassBg); themeUserBubble.value = rgbaToHex(state.config.colors.userBubble); themeUserText.value = state.config.colors.userText; themeAiBubble.value = rgbaToHex(state.config.colors.aiBubble); themeAiText.value = state.config.colors.aiText; fontFamilySelect.value = state.config.fontFamily; showView('settings'); });
            backBtns.forEach(btn => btn.addEventListener('click', () => showView('home')));
            avatarContainer.addEventListener('click', () => avatarUpload.click());

            const handleAssetUpload = async (file, assetKey, elementToUpdate, isImageSrc) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const dataUrl = event.target.result;
                    setAssetValue(state, assetKey, dataUrl);
                    if (isImageSrc) elementToUpdate.src = dataUrl;
                    else elementToUpdate.style.backgroundImage = `url(${dataUrl})`;
                    await saveState();
                    showToast('资源已更新');
                };
                reader.readAsDataURL(file);
            };

            avatarUpload.addEventListener('change', e => handleAssetUpload(e.target.files[0], 'avatarImage', avatarImg, true));
            bgUploadInput.addEventListener('change', e => handleAssetUpload(e.target.files[0], 'bgImage', phoneScreen, false));
            avatarFrameUploadInput.addEventListener('change', e => handleAssetUpload(e.target.files[0], 'avatarFrameImage', avatarFrame, true));
            bgUploadBtn.addEventListener('click', () => bgUploadInput.click());
            avatarFrameUploadBtn.addEventListener('click', () => avatarFrameUploadInput.click());

            const hexToRgba = (hex, alpha) => { const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; };
            const rgbaToHex = (rgba) => { if (!rgba || !rgba.startsWith('rgba')) return '#000000'; const parts = rgba.substring(rgba.indexOf('(') + 1, rgba.lastIndexOf(')')).split(','); const r = parseInt(parts[0].trim()), g = parseInt(parts[1].trim()), b = parseInt(parts[2].trim()); return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1); };
            
            fontUpload.addEventListener('change', async e => {
                if (!e.target.files || e.target.files.length === 0) return;
                const file = e.target.files[0];
                const defaultName = file.name.replace(/\.[^/.]+$/, "");
                const fontName = await showDialog('命名新字体', '请为你的新字体命名:', { input: true, defaultValue: defaultName, placeholder: '例如: 可爱的像素字体' });
                if (!fontName || state.config.customFonts[fontName]) { showToast(fontName ? '该字体名称已存在' : '已取消上传'); return; }
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const dataUrl = event.target.result;
                    state.config.customFonts[fontName] = dataUrl; await saveState(); renderFontOptions();
                    fontFamilySelect.value = fontName; await applyFont(fontName); state.config.fontFamily = fontName;
                    await saveState(); showToast(`字体 '${fontName}' 已添加并应用`);
                };
                reader.readAsDataURL(file);
            });
            
            fontFamilySelect.addEventListener('change', async e => {
                const selectedFont = e.target.value; state.config.fontFamily = selectedFont;
                await applyFont(selectedFont); await saveState();
            });

            const showFontManager = () => {
                const fontListContainer = document.createElement('div'); fontListContainer.className = 'space-y-2 max-h-60 overflow-y-auto';
                const customFonts = Object.keys(state.config.customFonts);
                if (customFonts.length === 0) { fontListContainer.innerHTML = `<p class="opacity-70 text-center">没有已导入的字体。</p>`; } 
                else {
                    customFonts.forEach(fontName => {
                        const item = document.createElement('div'); item.className = 'flex items-center justify-between p-2 bg-white/10 rounded';
                        const nameSpan = document.createElement('span'); nameSpan.textContent = fontName; item.appendChild(nameSpan);
                        const deleteBtn = document.createElement('button'); deleteBtn.innerHTML = `<i class="fas fa-trash-alt"></i>`; deleteBtn.className = 'p-2 text-red-400 hover:text-red-500';
                        deleteBtn.onclick = async () => {
                            const confirmed = await showDialog('确认删除', `确定要永久删除字体 "${fontName}" 吗？此操作无法撤销。`);
                            if (confirmed) {
                                if (state.config.fontFamily === fontName) { state.config.fontFamily = "'Inter', sans-serif"; await applyFont(state.config.fontFamily); fontFamilySelect.value = state.config.fontFamily; showToast(`当前字体 "${fontName}" 已删除，已切换回默认字体。`); } 
                                else { showToast(`字体 "${fontName}" 已删除。`); }
                                delete state.config.customFonts[fontName]; await db.delete('assets', `font-${fontName}`);
                                await saveState(); renderFontOptions(); showFontManager();
                            }
                        };
                        item.appendChild(deleteBtn); fontListContainer.appendChild(item);
                    });
                }
                showDialog('管理字体', fontListContainer, { buttons: [{ text: '关闭', value: true, class: 'bg-gray-500/50' }] });
            };
            manageFontsBtn.addEventListener('click', showFontManager);

            saveSettingsBtn.addEventListener('click', async () => {
                state.config.signature = get('signature-input').value; state.config.api.baseUrl = apiBaseUrl.value; state.config.api.key = apiKey.value; state.config.api.model = apiModel.value;
                state.config.colors.bgColor = themeBgColor.value; state.config.colors.textColor = themeTextColor.value; state.config.colors.glassBg = hexToRgba(themeGlassBg.value, 0.15); state.config.colors.userBubble = hexToRgba(themeUserBubble.value, 0.7);
                state.config.colors.userText = themeUserText.value; state.config.colors.aiBubble = hexToRgba(themeAiBubble.value, 0.8); state.config.colors.aiText = themeAiText.value;
                applyColors(state.config.colors); signatureDisplay.textContent = state.config.signature;
                await saveState(); showToast('设置已保存');
            });

            restoreAppearanceBtn.addEventListener('click', async () => {
                const confirmed = await showDialog('还原外观', '确定要移除背景图和头像框吗？');
                if (confirmed) { state.config.bgImage = null; state.config.avatarFrameImage = null; phoneScreen.style.backgroundImage = ''; avatarFrame.src = ''; await saveState(); showToast('已还原默认外观'); }
            });

            saveRoleBtn.addEventListener('click', async () => {
                state.role.playerName = get('player-name').value; state.role.playerGender = get('player-gender').value; state.role.playerPersona = get('player-persona').value; state.role.roleName = get('role-name').value; state.role.roleGender = get('role-gender').value; state.role.rolePersona = get('role-persona').value; state.role.promptInstructions = get('prompt-instructions').value;
                await saveState(); showToast('角色设置已保存');
            });

            // --- Fullscreen Functionality ---
            function toggleFullscreen() {
                document.body.classList.toggle('fullscreen-mode');
                const isFullscreen = document.body.classList.contains('fullscreen-mode');
                const icon = fullscreenBtn.querySelector('i');
                const text = fullscreenBtn.querySelector('span');

                if (isFullscreen) {
                    icon.className = 'fas fa-compress';
                    text.textContent = '退出全屏';
                    showToast('按 Esc 键可退出全屏');
                } else {
                    icon.className = 'fas fa-expand';
                    text.textContent = '全屏';
                }
            }
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.body.classList.contains('fullscreen-mode')) {
                    toggleFullscreen();
                }
            });

            // --- Chat Functionality ---
            const renderChatHistory = () => {
                chatHistory.innerHTML = ''; if (!state.chat.history) state.chat.history = [];
                state.chat.history.forEach((msg, index) => {
                    const bubble = document.createElement('div'); bubble.className = `message-bubble ${msg.sender}`; bubble.textContent = msg.text; bubble.dataset.index = index;
                    if(isChatBatchDeleteMode) {
                        bubble.classList.add('pl-12');
                        const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.className = 'batch-delete-checkbox form-checkbox h-5 w-5 bg-white/30 rounded text-indigo-500 border-none focus:ring-0';
                        bubble.prepend(checkbox);
                    } else {
                        let pressTimer;
                        bubble.addEventListener('mousedown', () => { pressTimer = setTimeout(() => manageChatMessage(index), 750); });
                        bubble.addEventListener('mouseup', () => clearTimeout(pressTimer)); bubble.addEventListener('mouseleave', () => clearTimeout(pressTimer));
                        bubble.addEventListener('touchstart', () => { pressTimer = setTimeout(() => manageChatMessage(index), 750); }, { passive: true });
                        bubble.addEventListener('touchend', () => clearTimeout(pressTimer));
                    }
                    chatHistory.appendChild(bubble);
                });
                chatFooter.style.display = isChatBatchDeleteMode ? 'none' : 'flex'; chatBatchActions.style.display = isChatBatchDeleteMode ? 'flex' : 'none';
                if (!isChatBatchDeleteMode) { chatHistory.scrollTop = chatHistory.scrollHeight; }
                affinityDisplay.textContent = `好感度：${state.chat.affinity}/100`;
            };

            const manageChatMessage = (index) => {
                const msg = state.chat.history[index]; if (!msg) return;
                showDialog('管理消息', `"${msg.text}"`, { buttons: [ {text: '取消', value: 'cancel', class: 'bg-gray-500/50'}, {text: '批量删除', value: 'batch-delete', class: 'bg-yellow-600/80'}, {text: '删除', value: 'delete', class: 'bg-red-500/80'}, {text: '编辑', value: 'edit', class: 'bg-blue-500'}]
                }).then(async action => {
                    if (action === 'edit') { const newText = await showDialog('编辑消息', '', { input: true, defaultValue: msg.text }); if (newText) { state.chat.history[index].text = newText; await saveState(); renderChatHistory(); showToast('消息已更新'); } } 
                    else if (action === 'delete') { const confirmed = await showDialog('确认删除', '确定要删除这条消息吗？'); if (confirmed) { state.chat.history.splice(index, 1); await saveState(); renderChatHistory(); showToast('消息已删除'); } } 
                    else if (action === 'batch-delete') { isChatBatchDeleteMode = true; renderChatHistory(); }
                });
            };

            const sendMessage = async (sender, text) => { if (!text || !text.trim()) return; state.chat.history.push({ sender, text }); if (sender === 'user') userInput.value = ''; await saveState(); renderChatHistory(); };
            async function sendAiMessages(texts) { for (const text of texts) { const trimmedText = text.trim(); if (trimmedText) { await sendMessage('ai', trimmedText); await new Promise(resolve => setTimeout(resolve, 400 + Math.random() * 400)); } } renderChatHistory(); }
            sendBtn.addEventListener('click', () => sendMessage('user', userInput.value));
            userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage('user', userInput.value); }});
            userInput.addEventListener('focus', () => { setTimeout(() => { chatFooter.scrollIntoView({ behavior: 'smooth', block: 'end' }); }, 300); });
            
            const createApiPrompt = () => {
                let systemPrompt = `# 核心情境
- 当前手机系统时间: ${new Date().toLocaleString('zh-CN', { hour12: false })}. 
- 你的账户余额: ${state.sui.balance.toFixed(2)}
- **时间意识指南**: 你需要将这个时间作为背景信息记在心里，让你的行为和对话自然地与之匹配（例如，在早上问好，在深夜表达困意）。**请不要在每次回复中都刻意播报时间**，只在对话自然地涉及到时间话题时才提及。最重要的是，**严禁说出与此参考时间相矛盾的时间信息**。

# 你的角色信息
- 名称: ${state.role.roleName || 'AI'}
- 性别: ${state.role.roleGender || '未设定'}
- 人设: ${state.role.rolePersona || '未设定'}

# 玩家信息
- 名称: ${state.role.playerName || '玩家'}
- 性别: ${state.role.playerGender || '未设定'}
- 人设: ${state.role.playerPersona || '未设定'}

# 重要规则
1. 你的回复必须模仿短信聊天，一次性发送多条短消息。请将你的回复分成至少3到15个独立的句子，并用句号、问号或感叹号结尾。
2:你必须以当前手机系统时间作为唯一参考，禁止出现回复错误时间的消息。
3. 在所有回复内容的最后，你必须根据用户最后一条消息的语气、内容和对你的态度，给出一个好感度变化值。格式必须为 [AFFINITY_CHANGE:X]，其中X是一个整数，范围从-5到+5。例如，如果用户非常友好，可以是 [AFFINITY_CHANGE:3]；如果用户很无礼，可以是 [AFFINITY_CHANGE:-4]。这个标签必须独立存在，并且是你回复的最后一部分，不要在它后面添加任何文字或标点。`;
                if(state.memories && state.memories.length > 0) {
                    systemPrompt += `\n\n# 你们共同的记忆 (用于参考):\n${state.memories.map(m => `- ${m.content}`).join('\n')}`;
                }
                if(state.role.promptInstructions) {
                    systemPrompt += `\n\n# 请遵循以下额外指令:\n${state.role.promptInstructions}`;
                }
                const messages = [{ role: 'system', content: systemPrompt }];
                state.chat.history.forEach(msg => {
                    messages.push({ role: msg.sender === 'user' ? 'user' : 'assistant', content: msg.text });
                });
                return messages;
            };

            async function initializeSuiBalance() {
                if (state.sui.isInitialized) return;
                const persona = state.role.rolePersona.toLowerCase();
                let balance = 0;
                if (/ceo|总裁|富豪|精英|董事长|投资人/.test(persona)) {
                    balance = 5000000 + Math.random() * 100000000; // High
                } else if (/学生|实习生|打工人|普通|贫穷|穷/.test(persona)) {
                    balance = 1000 + Math.random() * 5000; // Low
                } else {
                    balance = 50000 + Math.random() * 200000; // Medium
                }
                state.sui.balance = balance;
                state.sui.isInitialized = true;
                showToast(`【SUI：账户已激活，初始资金 ${balance.toFixed(2)}】`);
                await saveState(); // Save state after initialization
            }

            // --- SUI Helper: API Call Abstraction ---
            async function callSuiApi(systemPrompt) {
                if (!state.config.api.baseUrl || !state.config.api.key) return null;
                
                // 使用更明确的诊断信息
                console.log('%c[SUI] 正在调用SUI API...', 'color: #03a9f4; font-weight: bold;', { prompt: systemPrompt });

                try {
                    const messages = [{ role: 'system', content: systemPrompt }];
                    const response = await fetch(`${state.config.api.baseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.config.api.key}` },
                        body: JSON.stringify({ model: state.config.api.model || 'gpt-3.5-turbo', messages: messages, temperature: 0.6 })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`%c[SUI] API 请求失败，状态码: ${response.status}.`, 'color: #f44336; font-weight: bold;', '响应:', errorText);
                        return null;
                    }

                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content;

                    if (!content) {
                        console.warn('%c[SUI] API 响应中不包含任何内容。', 'color: #ffc107;');
                        return null;
                    }

                    console.log('%c[SUI] 从API收到原始文本:', 'color: #4caf50;', content);

                    // --- 核心优化：使用正则表达式提取JSON ---
                    // 这个正则表达式会寻找第一个出现的 '{...}' 或 '[...]' 结构，包括跨行的情况。
                    const jsonRegex = /({[\s\S]*})|(\[[\s\S]*\])/;
                    const match = content.match(jsonRegex);

                    if (!match) {
                        console.error('%c[SUI] 解析失败：在响应中未找到有效的JSON结构。', 'color: #f44336; font-weight: bold;');
                        return null;
                    }

                    const jsonString = match[0]; // match[0] 包含整个匹配到的字符串
                    console.log('%c[SUI] 正则表达式提取出的JSON字符串:', 'color: #ff9800;', jsonString);

                    try {
                        const parsedJson = JSON.parse(jsonString);
                        console.log('%c[SUI] JSON解析成功！', 'color: #8bc34a; font-weight: bold;', parsedJson);
                        return parsedJson;
                    } catch (e) {
                        console.error('%c[SUI] JSON解析失败，即使已经提取出字符串。', 'color: #f44336; font-weight: bold;', e, '问题字符串:', jsonString);
                        return null;
                    }

                } catch (error) {
                    console.error("%c[SUI] callSuiApi 函数发生严重错误:", 'color: #f44336; font-weight: bold;', error);
                    return null;
                }
            }

            // --- SUI Feature: Contextual Transaction Generation ---
            async function generateContextualTransaction() {
                const recentHistory = state.chat.history.slice(-6).map(msg => `${msg.sender === 'user' ? state.role.playerName || '玩家' : state.role.roleName || '角色'}: ${msg.text}`).join('\n');
                const currentTime = new Date().toLocaleString('zh-CN', { hour12: false });

                // MODIFIED: The prompt now asks for an array of 1-3 transactions.
                const systemPrompt = `你是一个智能生活模拟器，为AI角色生成金融交易。你需要决定这笔交易是与玩家对话相关，还是角色自己的独立行为。
# 核心信息
- 角色人设: ${state.role.rolePersona || '未设定'}
- 账户余额: ${state.sui.balance.toFixed(2)}
- 当前时间: ${currentTime}
- 最近对话: ${recentHistory}

# 任务：决策与生成
1.  **决策优先级 1 (情境关联)**: 首先，分析“最近对话”。对话中是否明确提到了任何与花钱或赚钱相关的行为？如果存在**强关联**，请生成与对话内容直接相关的交易。
2.  **决策优先级 2 (独立生活)**: 如果对话中**没有**强关联的触发点，请**忽略对话内容**。转而根据角色的“人设”和“当前时间”来构思一笔或多笔完全独立的、符合其生活逻辑的交易。
3.  **财务平衡原则**: 你的目标是模拟一个真实、动态的财务状况。**不要只生成收入或支出**。根据角色的生活方式和当前情境，合理地创造支出和收入（如日常消费、账单、娱乐）和收入（如薪水、奖金、投资回报）。账户应该有进有出，而不是单向增长或减少。
4.  **数量要求**: 你必须生成 **1 到 3 笔** 交易记录。
5.  **输出格式**: 必须返回一个JSON**数组**，其中包含1到3个交易对象。每个对象格式为 \`{"description": "交易描述", "amount": 数字}\`。如果经过判断，当前不适合生成任何交易，则返回一个空数组: \`[]\`。

# 示例输出
[
  {"description": "支付上月信用卡账单", "amount": -8540.50},
  {"description": "收到项目奖金", "amount": 15000}
]`;

                const transactionsData = await callSuiApi(systemPrompt);

                // MODIFIED: The logic now handles an array of transactions.
                if (Array.isArray(transactionsData) && transactionsData.length > 0) {
                    let totalChange = 0;
                    // Iterate over the array of transactions returned by the AI
                    for (const transaction of transactionsData) {
                        if (transaction.description && typeof transaction.amount === 'number') {
                            const newItem = {
                                id: Date.now() + Math.random(), // Add random to avoid collision in fast loops
                                timestamp: new Date().toLocaleString('zh-CN', { hour12: false }),
                                description: transaction.description,
                                amount: transaction.amount
                            };
                            state.sui.transactions.unshift(newItem);
                            totalChange += newItem.amount;
                        }
                    }

                    if (transactionsData.length > 0) {
                        state.sui.balance += totalChange;
                        // Show a single toast summarizing the changes.
                        showToast(`【SUI：新增 ${transactionsData.length} 笔账户变动】`);
                        if (pages.sui.offsetParent !== null) {
                            renderSuiPage();
                        }
                        await saveState();
                    }
                }
            }
            
            // --- SUI Feature: AI-Generated Other Chats ---
            async function generateSuiOtherChat() {
                const roleName = state.role.roleName || '角色';
                const currentTime = new Date().toLocaleString('zh-CN', { hour12: false });
                const recentHistory = state.chat.history.slice(-6).map(msg => `${msg.sender === 'user' ? state.role.playerName || '玩家' : state.role.roleName || '角色'}: ${msg.text}`).join('\n');

                const systemPrompt = `你是一个智能生活模拟器，为AI角色“${roleName}”生成外部通讯。你需要决定这次通讯是与玩家对话相关，还是角色自己的独立行为。
# 核心信息
- 角色人设: ${state.role.rolePersona || '未设定'}
- 当前时间: ${currentTime}
- 与玩家的最近对话: ${recentHistory}

# 任务：决策与生成
1.  **决策优先级 1 (情境关联)**: 首先，分析“与玩家的最近对话”。对话中是否提到了某个具体的人、或一个涉及他人的约定（如“我等下要去见王教授”、“我妹妹快生日了”）？如果存在**强关联**，请生成一段“${roleName}”与该相关人物的对话。
2.  **决策优先级 2 (独立生活)**: 如果对话中**没有**强关联的触发点，请**忽略对话内容**。转而根据角色的“人设”和“当前时间”来构思一段完全独立的、符合其生活逻辑的对话（如与同事讨论工作、与朋友闲聊、家人的问候等）。
3.  **输出格式**: 必须以JSON格式返回，不要包含任何解释。
# JSON格式:
{
  "with": "对方姓名",
  "log": [
    {"sender": "发送者姓名", "text": "消息内容"}
  ]
}`;
                const chatData = await callSuiApi(systemPrompt);
                if (chatData && chatData.with && Array.isArray(chatData.log) && chatData.log.length > 0) {
                    const newItem = { id: Date.now(), timestamp: new Date().toLocaleString('zh-CN', { hour12: false }), with: chatData.with, log: chatData.log };
                    state.sui.otherChats.unshift(newItem);
                    showToast(`【SUI：收到来自 ${chatData.with} 的新消息】`);
                    if (pages.sui.offsetParent !== null) { renderSuiPage(); }
                    await saveState();
                }
            }

            // --- SUI Feature: AI-Generated Browsing Session ---
            async function generateSuiBrowsingSession() {
                const currentTime = new Date().toLocaleString('zh-CN', { hour12: false });
                const recentHistory = state.chat.history.slice(-6).map(msg => `${msg.sender === 'user' ? state.role.playerName || '玩家' : state.role.roleName || '角色'}: ${msg.text}`).join('\n');

                const systemPrompt = `你是一个智能生活模拟器，为AI角色生成网页浏览记录。你需要决定这次浏览是与玩家对话相关，还是角色自己的独立行为。
# 核心信息
- 角色人设: ${state.role.rolePersona || '未设定'}
- 当前时间: ${currentTime}
- 与玩家的最近对话: ${recentHistory}

# 任务：决策与生成
1.  **决策优先级 1 (情境关联)**: 首先，分析“与玩家的最近对话”。对话中是否提到了某个需要查询信息的话题（如一部电影、一个地点、一个知识点、一件商品）？如果存在**强关联**，请生成一段与该话题直接相关的浏览记录。
2.  **决策优先级 2 (独立生活)**: 如果对话中**没有**强关联的触发点，请**忽略对话内容**。转而根据角色的“人设”、“职业”或“兴趣爱好”来构思一段完全独立的浏览记录（如工作查资料、看新闻、刷社交媒体、网上购物等）。
3.  **输出格式**: 必须以JSON格式返回，不要包含任何解释。
# JSON格式:
{
  "session": [
    {"title": "页面标题", "url": "页面URL"}
  ]
}`;
                const browsingData = await callSuiApi(systemPrompt);
                if (browsingData && Array.isArray(browsingData.session) && browsingData.session.length > 0) {
                    const newItem = { id: Date.now(), timestamp: new Date().toLocaleString('zh-CN', { hour12: false }), session: browsingData.session };
                    state.sui.browsingHistory.unshift(newItem);
                    showToast(`【SUI：检测到新的浏览活动】`);
                    if (pages.sui.offsetParent !== null) { renderSuiPage(); }
                    await saveState();
                }
            }

            // --- SUI Trigger (Called after AI reply) ---
            async function triggerSuiGeneration() {
                if (!state.config.api.key) return; // Only check for API key
                
                await initializeSuiBalance(); 

                const generationTasks = [];

                // Probabilities for SUI events
                const transactionChance = 0.65; 
                const otherChatChance = 0.55;   
                const browsingChance = 0.55;  

                if (Math.random() < transactionChance) {
                    generationTasks.push(generateContextualTransaction());
                }
                if (Math.random() < otherChatChance) {
                    generationTasks.push(generateSuiOtherChat());
                }
                if (Math.random() < browsingChance) {
                    generationTasks.push(generateSuiBrowsingSession());
                }

                if (generationTasks.length > 0) {
                    await Promise.all(generationTasks);
                }
            }

            aiReplyBtn.addEventListener('click', async () => {
                if (!state.config.api.baseUrl || !state.config.api.key) { showDialog('API错误', '请在设置中配置API参数！').then(() => { showView('settings'); }); return; }
                showToast('角色正在思考中...'); aiReplyBtn.disabled = true;
                try {
                    const messages = createApiPrompt();
                    const response = await fetch(`${state.config.api.baseUrl}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.config.api.key}` }, body: JSON.stringify({ model: state.config.api.model || 'gpt-3.5-turbo', messages: messages, temperature: 0.7, stream: false }) });
                    if (!response.ok) { const errorData = await response.json().catch(() => ({ error: { message: '无法解析错误响应' } })); throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error?.message || '未知网络错误'}`); }
                    const data = await response.json(); if (data.error) { throw new Error(`API返回错误: ${data.error.message}`); }
                    const choice = data.choices?.[0]; if (!choice) { throw new Error("无法解析API响应格式：响应中缺少 'choices' 数组或数组为空。"); }
                    if (choice.finish_reason === 'content_filter') { throw new Error("AI回复因内容安全策略被拦截。"); }
                    let aiResponse = choice.message?.content;
                    if (!aiResponse) { if (choice.finish_reason === 'length') { throw new Error("AI回复因达到最大长度限制而被截断，且内容为空。请检查API的max_tokens设置。"); } throw new Error("无法解析API响应格式：在API的成功响应中未找到有效的 'content' 内容。"); }
                    
                    const affinityRegex = /\[AFFINITY_CHANGE:(-?\d+)\]/; const match = aiResponse.match(affinityRegex);
                    if (match && match[1]) { state.chat.affinity = Math.max(0, Math.min(100, state.chat.affinity + parseInt(match[1], 10))); aiResponse = aiResponse.replace(affinityRegex, '').trim(); }
                    const replyMessages = aiResponse.match(/[^。！？?!]+[。！？?!]?/g) || [aiResponse];
                    await sendAiMessages(replyMessages);

                    await triggerSuiGeneration();

                } catch (error) { console.error("API请求失败:", error); showDialog('API请求失败', `错误: ${error.message}`); } finally { aiReplyBtn.disabled = false; }
            });

            restartChatBtn.addEventListener('click', async () => { const ok = await showDialog('新对话', '确定要清除所有聊天记录吗？这也会将好感度重置为0。'); if (ok) { state.chat = { history: [], affinity: 0 }; await saveState(); renderChatHistory(); showToast('对话已清空'); } });
            cancelBatchDeleteChatBtn.addEventListener('click', () => { isChatBatchDeleteMode = false; renderChatHistory(); });
            confirmBatchDeleteChatBtn.addEventListener('click', async () => {
                const indicesToDelete = []; chatHistory.querySelectorAll('.message-bubble').forEach(bubble => { const checkbox = bubble.querySelector('.batch-delete-checkbox'); if (checkbox && checkbox.checked) { indicesToDelete.push(parseInt(bubble.dataset.index)); } });
                if (indicesToDelete.length === 0) { showToast('没有选中任何消息'); return; }
                const confirmed = await showDialog('批量删除', `确定要删除选中的 ${indicesToDelete.length} 条消息吗？`);
                if (confirmed) { indicesToDelete.sort((a, b) => b - a).forEach(index => state.chat.history.splice(index, 1)); await saveState(); isChatBatchDeleteMode = false; renderChatHistory(); showToast('消息已删除'); }
            });
            
            summarizeMemoryBtn.addEventListener('click', async () => {
                if (state.chat.history.length === 0) { showDialog('错误', '没有聊天记录可以总结。'); return; } if (!state.config.api.baseUrl || !state.config.api.key) { showDialog('API错误', '请在设置中配置API参数！').then(() => { showView('settings'); }); return; }
                showToast('正在总结聊天内容...'); summarizeMemoryBtn.disabled = true;
                try {
                    const chatContent = state.chat.history.map(msg => `${msg.sender === 'user' ? state.role.playerName || '玩家' : state.role.roleName || '角色'}：${msg.text}`).join('\n');
                    const systemPrompt = "你是一名记忆助手。请根据提供的对话内容，总结出关键要点、主题或重要信息，形成一个简洁的记忆存档。"; const messages = [ { role: 'system', content: systemPrompt }, { role: 'user', content: `对话内容:\n${chatContent}\n\n请简洁地总结以上对话内容，例如：'玩家与[角色]在[地点]讨论了[主题]。'` } ];
                    const response = await fetch(`${state.config.api.baseUrl}/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.config.api.key}` }, body: JSON.stringify({ model: state.config.api.model || 'gpt-3.5-turbo', messages: messages, temperature: 0.3 }) });
                    if (!response.ok) { const errorData = await response.json().catch(() => ({})); throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error?.message || 'Unknown error'}`); }
                    const data = await response.json(); let summaryText = data.choices?.[0]?.message?.content;
                    if (summaryText) { state.memories.push({ id: Date.now(), content: summaryText, timestamp: new Date().toLocaleString() }); await saveState(); renderMemoryList(); showToast('记忆已成功存档！'); } else { throw new Error("API response is empty or malformed."); }
                } catch (error) { console.error("API请求失败:", error); showDialog('API请求失败', `总结记忆时发生错误: ${error.message}`); } finally { summarizeMemoryBtn.disabled = false; }
            });
            
            // --- Memory Page ---
            addMemoryBtn.addEventListener('click', async () => { const content = await showDialog('添加新记忆', '请输入记忆内容:', { input: true, defaultValue: '' }); if (content) { state.memories.push({ id: Date.now(), content, timestamp: new Date().toLocaleString() }); await saveState(); renderMemoryList(); showToast('记忆已添加'); } });
            const renderMemoryList = () => {
                if (!state.memories) state.memories = [];
                memoryListEl.innerHTML = state.memories.length === 0 ? '<p class="opacity-70 text-center">沒有记忆存档。</p>' : '';
                [...state.memories].reverse().forEach(mem => {
                    const item = document.createElement('div'); item.className = 'memory-item'; item.dataset.id = mem.id;
                    let innerHTML = `<p class="whitespace-pre-wrap">${mem.content}</p><p class="text-xs opacity-50 mt-1">${mem.timestamp}</p>`;
                    if (isMemoryBatchDeleteMode) { item.classList.add('pl-12'); innerHTML = `<input type="checkbox" class="batch-delete-checkbox form-checkbox h-5 w-5 bg-white/30 rounded text-indigo-500 border-none focus:ring-0">` + innerHTML; }
                    item.innerHTML = innerHTML;
                    if (!isMemoryBatchDeleteMode) { item.addEventListener('click', () => showMemoryDetails(mem.id)); }
                    memoryListEl.appendChild(item);
                });
                memoryBatchActions.style.display = isMemoryBatchDeleteMode ? 'flex' : 'none';
            };
            const showMemoryDetails = (memId) => {
                const memIndex = state.memories.findIndex(m => m.id === memId); if (memIndex === -1) return; const mem = state.memories[memIndex];
                showDialog('管理记忆', '请选择操作', { buttons: [{text: '取消', value: 'cancel', class: 'bg-gray-500/50'}, {text: '删除', value: 'delete', class: 'bg-red-500/80'}, {text: '编辑', value: 'edit', class: 'bg-blue-500'}]
                }).then(async action => {
                    if (action === 'edit') { const newContent = await showDialog('编辑记忆', '', { input: true, defaultValue: mem.content }); if (newContent) { state.memories[memIndex].content = newContent; state.memories[memIndex].timestamp = new Date().toLocaleString(); await saveState(); renderMemoryList(); showToast('记忆已更新'); } } 
                    else if (action === 'delete') { const confirmed = await showDialog('确认删除', '确定要删除这条记忆吗？'); if (confirmed) { state.memories.splice(memIndex, 1); await saveState(); renderMemoryList(); showToast('记忆已删除'); } }
                });
            };
            batchDeleteMemoriesBtn.addEventListener('click', () => { isMemoryBatchDeleteMode = true; renderMemoryList(); }); cancelBatchDeleteMemoriesBtn.addEventListener('click', () => { isMemoryBatchDeleteMode = false; renderMemoryList(); });
            confirmBatchDeleteMemoriesBtn.addEventListener('click', async () => {
                const selectedIds = []; memoryListEl.querySelectorAll('.memory-item').forEach(item => { const checkbox = item.querySelector('.batch-delete-checkbox'); if (checkbox && checkbox.checked) { selectedIds.push(parseInt(item.dataset.id)); } });
                if (selectedIds.length === 0) { showToast('没有选中任何记忆'); return; }
                const confirmed = await showDialog('批量删除', `确定要删除选中的 ${selectedIds.length} 条记忆吗？`);
                if (confirmed) { state.memories = state.memories.filter(d => !selectedIds.includes(d.id)); await saveState(); isMemoryBatchDeleteMode = false; renderMemoryList(); showToast('记忆已删除'); }
            });

            // --- Diary Page ---
            const renderMarkdown = (text) => text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/~~(.*?)~~/g, '<del>$1</del>');
            const renderDiaryList = () => {
                if (!state.diaries) state.diaries = [];
                diaryListContainer.innerHTML = state.diaries.length === 0 ? '<p class="opacity-70 text-center">还没有日记，试着生成一篇吧。</p>' : '';
                [...state.diaries].reverse().forEach(diary => {
                    const item = document.createElement('div'); item.className = 'diary-entry'; item.dataset.id = diary.id; let innerHTML = '';
                    if (isDiaryBatchDeleteMode) { innerHTML += `<input type="checkbox" class="batch-delete-checkbox form-checkbox h-5 w-5 bg-white/30 rounded text-indigo-500 border-none focus:ring-0">`; item.classList.add('pl-12'); } 
                    else { innerHTML += `<button class="diary-delete-btn" title="删除日记"><i class="fas fa-times"></i></button>`; item.classList.remove('pl-12'); }
                    innerHTML += `<p class="text-xs opacity-50 mb-2">${diary.timestamp}</p><div class="diary-content">${renderMarkdown(diary.content)}</div>`;
                    item.innerHTML = innerHTML;
                    if (!isDiaryBatchDeleteMode) { item.querySelector('.diary-delete-btn').addEventListener('click', (e) => { e.stopPropagation(); showDialog('删除日记', '确定要删除这篇日记吗？').then(async confirmed => { if (confirmed) { state.diaries = state.diaries.filter(d => d.id !== diary.id); await saveState(); renderDiaryList(); showToast('日记已删除'); } }); }); }
                    diaryListContainer.appendChild(item);
                });
                diaryBatchActions.style.display = isDiaryBatchDeleteMode ? 'flex' : 'none';
            };
            generateDiaryBtn.addEventListener('click', async () => {
                if (state.chat.history.length < 5) { showDialog('无法生成', '聊天记录太少，无法生成有意义的日记。'); return; } if (!state.config.api.baseUrl || !state.config.api.key) { showDialog('API错误', '请在设置中配置API参数！').then(() => { showView('settings'); }); return; }
                showToast('AI正在撰写日记...'); generateDiaryBtn.disabled = true;
                try {
                    const systemPrompt = `你叫 ${state.role.roleName || '角色'}, 你的设定是: ${state.role.rolePersona}. 你正在与名为 ${state.role.playerName || '玩家'} 的人互动。\n请你以第一人称视角，根据你们的共同记忆和最近的对话，写一篇充满感情、至少200字的日记。\n共同记忆: ${state.memories.map(m => `- ${m.content}`).join('\n') || '暂无'}\n最近的对话(最多20条):\n${state.chat.history.slice(-20).map(msg => `${msg.sender === 'user' ? state.role.playerName || '玩家' : '我'}: ${msg.text}`).join('\n')}\n\n写作要求:\n- 风格必须是私密的日记风格，展现你的内心世界和对玩家的真实感受。\n- 必须超过200字。\n- 使用Markdown语法来强调: **加粗表示强烈的感情**, *斜体表示悄悄的想法或疑问*, ~~删除线表示被否定或放弃的念头~~。\n- 直接开始写日记内容，不要有“亲爱的日记”或任何标题。`;
                    const messages = [{ role: 'system', content: systemPrompt }];
                    const response = await fetch(`${state.config.api.baseUrl}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.config.api.key}` }, body: JSON.stringify({ model: state.config.api.model || 'gpt-3.5-turbo', messages: messages, temperature: 0.8 }) });
                    if (!response.ok) { const errorData = await response.json().catch(() => ({})); throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error?.message || 'Unknown error'}`); }
                    const data = await response.json(); const diaryContent = data.choices?.[0]?.message?.content;
                    if (diaryContent) { state.diaries.push({ id: Date.now(), content: diaryContent, timestamp: new Date().toLocaleString() }); await saveState(); renderDiaryList(); showToast('日记已生成！'); } else { throw new Error("API did not return diary content."); }
                } catch (error) { console.error("Diary generation failed:", error); showDialog('生成失败', `生成日记时发生错误: ${error.message}`); } finally { generateDiaryBtn.disabled = false; }
            });
            batchDeleteDiariesBtn.addEventListener('click', () => { isDiaryBatchDeleteMode = true; renderDiaryList(); }); cancelBatchDeleteBtn.addEventListener('click', () => { isDiaryBatchDeleteMode = false; renderDiaryList(); });
            confirmBatchDeleteBtn.addEventListener('click', async () => {
                const selectedIds = []; diaryListContainer.querySelectorAll('.diary-entry').forEach(entry => { const checkbox = entry.querySelector('.batch-delete-checkbox'); if (checkbox && checkbox.checked) { selectedIds.push(parseInt(entry.dataset.id)); } });
                if (selectedIds.length === 0) { showToast('没有选中任何日记'); return; }
                const confirmed = await showDialog('批量删除', `确定要删除选中的 ${selectedIds.length} 篇日记吗？`);
                if (confirmed) { state.diaries = state.diaries.filter(d => !selectedIds.includes(d.id)); await saveState(); isDiaryBatchDeleteMode = false; renderDiaryList(); showToast('日记已删除'); }
            });

            // --- SUI Page Functionality ---
            suiNav.addEventListener('click', (e) => {
                const targetBtn = e.target.closest('.sui-nav-btn');
                if (!targetBtn) return;
                suiNavBtns.forEach(btn => btn.classList.remove('active'));
                targetBtn.classList.add('active');
                const targetSectionId = targetBtn.dataset.target;
                suiContentSections.forEach(section => {
                    section.classList.toggle('hidden', section.id !== targetSectionId);
                });
            });

            const renderSuiPage = () => {
                suiBalanceEl.textContent = (state.sui.balance || 0).toFixed(2);
                
                const renderList = (element, data, renderItem) => {
                    element.innerHTML = '';
                    if (!data || data.length === 0) {
                        element.innerHTML = '<p class="opacity-70 text-center">暂无记录</p>';
                        return;
                    }
                    [...data].forEach(itemData => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'sui-list-item';
                        itemEl.innerHTML = renderItem(itemData);
                        element.appendChild(itemEl);
                    });
                };

                // --- REPLACED FUNCTION ---
                const formatMemoryFromSui = (item, type) => {
                    const roleName = state.role.roleName || '角色';
                    switch (type) {
                        case 'transactions':
                            // 完整记录交易描述和精确金额
                            return `【账户变动记录】描述: ${item.description}, 金额: ${item.amount.toFixed(2)}`;
                        
                        case 'otherChats':
                            // 完整记录与谁的、全部的对话内容
                            const chatLogString = (item.log || [])
                                .map(logItem => `${logItem.sender || '未知'}: ${logItem.text || ''}`)
                                .join('\n');
                            return `【外部通讯记录】与 ${item.with || '未知联系人'} 的对话:\n${chatLogString}`;

                        case 'browsingHistory':
                            // 完整记录一次浏览会话中的所有页面
                            const sessionString = (item.session || [])
                                .map(page => `- 标题: ${page.title || '无标题'}, 网址: ${page.url || '未知URL'}`)
                                .join('\n');
                            return `【网页浏览记录】\n${sessionString}`;
                            
                        default:
                            return '';
                    }
                };

                const createActionButtons = (item, type) => `
                    <div class="absolute top-0 right-0 flex items-center">
                        <button class="sui-item-action-btn" title="植入记忆" data-id="${item.id}" data-type="${type}" data-action="memorize"> <i class="fas fa-brain"></i> </button>
                        <button class="sui-item-action-btn" title="删除" data-id="${item.id}" data-type="${type}" data-action="delete"> &times; </button>
                    </div>
                `;
                
                const style = document.createElement('style');
                style.innerHTML = `
                    .sui-list-item:hover .sui-item-action-btn { opacity: 1; }
                    .sui-item-action-btn { background: none; border: none; color: var(--text-color); opacity: 0; cursor: pointer; transition: all 0.2s; font-size: 1.1rem; line-height: 1; padding: 0.5rem; border-radius: 50%; }
                    .sui-item-action-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }
                    .sui-item-action-btn[data-action="delete"] { font-size: 1.5rem; }
                `;
                if (!document.head.querySelector('#sui-action-btn-style')) { style.id = 'sui-action-btn-style'; document.head.appendChild(style); }

                renderList(suiTransactionsListEl, state.sui.transactions, item => {
                    const amount = item.amount || 0; const amountClass = amount > 0 ? 'amount-positive' : 'amount-negative'; const amountSign = amount > 0 ? '+' : '';
                    return `${createActionButtons(item, 'transactions')} <span class="timestamp">${item.timestamp || '未知时间'}</span> <div class="flex justify-between"> <span>${item.description || '无描述'}</span> <span class="font-mono ${amountClass}">${amountSign}${amount.toFixed(2)}</span> </div>`;
                });
                
                renderList(suiOtherChatsListEl, state.sui.otherChats, item => {
                    const logHtml = (item.log || []).map(logItem => `<p><strong>${logItem.sender || '未知'}:</strong> ${logItem.text || ''}</p>`).join('');
                    return `${createActionButtons(item, 'otherChats')} <span class="timestamp">${item.timestamp || '未知时间'}</span> <div> <span>与 <span class="chat-with">${item.with || '未知联系人'}</span> 的通讯:</span> <div class="sui-chat-log">${logHtml || '无对话记录'}</div> </div>`;
                });

                renderList(suiBrowsingHistoryListEl, state.sui.browsingHistory, item => {
                    const sessionHtml = (item.session || []).map(page => `<p class="truncate" title="${page.title || ''}\n${page.url || ''}"> ${page.title || '无标题'} <span class="block url truncate">${page.url || '未知URL'}</span> </p>`).join('');
                    return `${createActionButtons(item, 'browsingHistory')} <span class="timestamp">${item.timestamp || '未知时间'}</span> <div class="sui-browsing-session">${sessionHtml || '无浏览记录'}</div>`;
                });

                const handleSuiAction = async (e) => {
                    const actionBtn = e.target.closest('.sui-item-action-btn'); if (!actionBtn) return;
                    const id = parseFloat(actionBtn.dataset.id); const type = actionBtn.dataset.type; const action = actionBtn.dataset.action; const item = state.sui[type]?.find(i => i.id === id); if (!item) return;
                    if (action === 'delete') {
                        const confirmed = await showDialog('确认删除', '确定要删除这条记录吗？');
                        if (confirmed) { state.sui[type] = state.sui[type].filter(i => i.id !== id); await saveState(); renderSuiPage(); showToast('记录已删除'); }
                    } else if (action === 'memorize') {
                        const memoryContent = formatMemoryFromSui(item, type);
                        if (memoryContent) {
                            const confirmed = await showDialog('植入记忆', `确定要让角色记住以下信息吗？<br><br><p class="p-2 bg-black/20 rounded-md text-sm whitespace-pre-wrap">${memoryContent}</p>`);
                            if (confirmed) { state.memories.push({ id: Date.now(), content: memoryContent, timestamp: new Date().toLocaleString() }); await saveState(); showToast('记忆已成功植入！'); }
                        }
                    }
                };

                [suiTransactionsListEl, suiOtherChatsListEl, suiBrowsingHistoryListEl].forEach(listEl => {
                    const newListEl = listEl.cloneNode(true); listEl.parentNode.replaceChild(newListEl, listEl); newListEl.addEventListener('click', handleSuiAction);
                });

                suiTransactionsListEl = get('sui-transactions-list'); suiOtherChatsListEl = get('sui-other-chats-list'); suiBrowsingHistoryListEl = get('sui-browsing-history-list');
            };

            suiClearBtn.addEventListener('click', async () => {
                const dialogContent = document.createElement('div');
                dialogContent.innerHTML = `
                    <div class="space-y-2">
                        <label class="flex items-center"><input type="checkbox" id="clear-sui-account" class="form-checkbox mr-2">清空账户信息（余额和交易记录）</label>
                        <label class="flex items-center"><input type="checkbox" id="clear-sui-comms" class="form-checkbox mr-2">清空外部通讯记录</label>
                        <label class="flex items-center"><input type="checkbox" id="clear-sui-browsing" class="form-checkbox mr-2">清空浏览记录</label>
                    </div>
                `;
                const choices = await showDialog('清空SUI记录', dialogContent, {
                    buttons: [{ text: '取消', value: false, class: 'bg-gray-500/50' }, { text: '确认清空', value: true, class: 'bg-red-600' }],
                    getValues: () => ({
                        account: dialogContent.querySelector('#clear-sui-account').checked,
                        comms: dialogContent.querySelector('#clear-sui-comms').checked,
                        browsing: dialogContent.querySelector('#clear-sui-browsing').checked,
                    })
                });

                if (choices) {
                    let cleared = false;
                    if (choices.account) { state.sui.balance = 0; state.sui.transactions = []; state.sui.isInitialized = false; cleared = true; }
                    if (choices.comms) { state.sui.otherChats = []; cleared = true; }
                    if (choices.browsing) { state.sui.browsingHistory = []; cleared = true; }
                    if (cleared) { await saveState(); renderSuiPage(); showToast('所选记录已清空'); }
                }
            });

            // --- Data Export/Import ---
            exportDataBtn.addEventListener('click', async () => {
                const confirmed = await showDialog('导出数据', '这将导出一个包含所有设置、聊天、记忆、日记和全部媒体文件（包括音频）的JSON文件。文件可能会非常大。是否继续？');
                if (!confirmed) return;
                try {
                    showToast('正在准备导出数据...'); const stateToExport = JSON.parse(JSON.stringify(state));
                    for (const key in ASSET_KEYS) { if (ASSET_KEYS[key](stateToExport) === 'indexed') { const data = await db.get('assets', key); if (data) setAssetValue(stateToExport, key, data); } }
                    if (stateToExport.config.customFonts) { for (const fontName in stateToExport.config.customFonts) { if (stateToExport.config.customFonts[fontName] === 'indexed') { const fontData = await db.get('assets', `font-${fontName}`); if (fontData) stateToExport.config.customFonts[fontName] = fontData; } } }
                    // Handle music files
                    if (stateToExport.music && stateToExport.music.playlist) {
                        const playlistWithData = [];
                        for (const song of stateToExport.music.playlist) {
                            const songData = await db.get('assets', `music-${song.name}`);
                            if (songData) { playlistWithData.push({ name: song.name, data: songData }); }
                        }
                        stateToExport.music.playlist = playlistWithData;
                    }
                    const dataStr = JSON.stringify(stateToExport);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `攻略计划_数据备份_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('数据导出成功！');
                } catch (e) {
                    console.error("Export failed:", e);
                    showDialog('导出失败', '导出数据时发生错误，请检查控制台获取详细信息。');
                }
            });
            
            importDataBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0]; if (!file) return;
                const confirmed = await showDialog('导入数据', '警告：这将覆盖所有当前数据，包括设置、聊天记录和媒体文件。此操作无法撤销。是否继续？', { buttons: [{text: '取消', value: false, class: 'bg-gray-500/50'}, {text: '确认导入', value: true, class: 'bg-red-600'}] });
                if (!confirmed) { importFileInput.value = null; return; }
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (!importedData.version || !importedData.config) { throw new Error('无效的数据文件格式。'); }
                        
                        // Clear existing music assets before import to avoid orphans
                        if (state.music && state.music.playlist) {
                            for (const song of state.music.playlist) {
                                await db.delete('assets', `music-${song.name}`).catch(e => console.warn(`Could not delete old music asset: ${song.name}`, e));
                            }
                        }

                        // Handle music data from imported file
                        if (importedData.music && importedData.music.playlist) {
                            const playlistForState = [];
                            for (const song of importedData.music.playlist) {
                                if (song.name && song.data) {
                                    await db.set('assets', `music-${song.name}`, song.data);
                                    playlistForState.push({ name: song.name });
                                }
                            }
                            importedData.music.playlist = playlistForState;
                        }

                        Object.assign(state, importedData);
                        await saveState(); // This will save assets to IndexedDB and metadata to localStorage
                        showDialog('导入成功', '数据已成功导入。页面即将刷新以应用更改。').then(() => { location.reload(); });
                    } catch (e) {
                        console.error('Import failed:', e);
                        showDialog('导入失败', `无法处理文件: ${e.message}`);
                    }
                };
                reader.onerror = () => showDialog('读取文件失败', '无法读取所选文件。');
                reader.readAsText(file);
                importFileInput.value = null;
            });

            // Initial load
            await loadState();
            initTouchEffects();
        })();
    </script>
</body>
</html>